<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>cloudtrail_anomaly_detection | JellyParks</title><meta name=keywords content="aws,cloud,dfir"><meta name=description content="Overview of an anomaly detection platform using cloudtrail logs, athena, lambda, s3, and dynamodb"><meta name=author content="Travis"><link rel=canonical href=https://jellyparks.com/posts/cloudtrail-anomaly-detection/><link crossorigin=anonymous href=/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css integrity="sha256-7I2jZsovtkdTfMt6j2+ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://jellyparks.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://jellyparks.com/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://jellyparks.com/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://jellyparks.com/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://jellyparks.com/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-13VPCR43BS"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-13VPCR43BS",{anonymize_ip:!1})}</script><meta property="og:title" content="cloudtrail_anomaly_detection"><meta property="og:description" content="Overview of an anomaly detection platform using cloudtrail logs, athena, lambda, s3, and dynamodb"><meta property="og:type" content="article"><meta property="og:url" content="https://jellyparks.com/posts/cloudtrail-anomaly-detection/"><meta property="og:image" content="https://jellyparks.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-11-28T00:00:00+00:00"><meta property="article:modified_time" content="2018-11-28T00:00:00+00:00"><meta property="og:site_name" content="JellyParks"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://jellyparks.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="cloudtrail_anomaly_detection"><meta name=twitter:description content="Overview of an anomaly detection platform using cloudtrail logs, athena, lambda, s3, and dynamodb"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://jellyparks.com/posts/"},{"@type":"ListItem","position":3,"name":"cloudtrail_anomaly_detection","item":"https://jellyparks.com/posts/cloudtrail-anomaly-detection/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"cloudtrail_anomaly_detection","name":"cloudtrail_anomaly_detection","description":"Overview of an anomaly detection platform using cloudtrail logs, athena, lambda, s3, and dynamodb","keywords":["aws","cloud","dfir"],"articleBody":" This is going to be an ongoing post for awhile. It was inspired by Netflix’s skunkworks group who gave a talk at re:invent 2019 in regards to building a cloudtrail anomaly detection platform leveraging Amazon services. I highly recommend watching the talk.\nI liked the idea, but not the deployment method netflix showcased. It didn’t scale to the size I needed it to (Looking at the final product in production now it probably would have, but I didn’t want to run and maintain an EC2 instance). Additionally there were also some aspects that I reworked to lessen the load (and cost) of Athena queries. We’ll talk more about these differences and more further in the post. This post will walk through this code.\n Data Flow Below is how the data and api calls are made within aws. The code in the middle is several Lambda scripts but for the data flow it made sense to consolodate them into a single entity.\nAn high level explaination for each of the steps in the diagram is below:\n Query main orgaization account for a list of all accounts within the organization Configure Athena tables, start query execution Athena queries the CloudTrail S3 bucket(s) for all activity per account for the past hour Athena sends results to S3 results bucket Athena returns ‘Success’ message with along with the results object Scripts grabs the results and parses them by unique role, event source, and event name Each unique record is checked against DynamoDB table. If its new alert (if it meets criteria). Send alerts to Splunk   Inspiration The original design is a script that runs off an Ec2 instance with the required role to access the CloudTrail events, Athena, S3, and DynamoDB. The original repo is here and I forked it here.\n Structural Differences While porting the original concept over from what Netflix released. I decided that I didn’t want to have to deal with the run and maintain of an EC2 instance. While its not a huge deal, it was just something that I didn’t want to do. This is where we have our first major structural difference between the original source, and what was rolled into production. The deployment in my github repo is serverless. Kicked off by cron jobs running every hour.\nBelow is a expanded data flow showing the Lambda scripts, and what occurs at each stage.\n Main Lambda function (Muster) kicks off based on CloudWatch cron configuration. It queries for account numbers in the organization, builds a date object, and for each account it sends the account, date object, and miscellaneous variables into an SNS message to trigger the discernment Lambdas. SNS message triggers discernment Lambdas. One account per Lambda execution. The discernment lambda checks for an Athena table for the account, if it doesn’t exist it makes it, it also builds the table partition if it does not exist. Queries the CloudTrail logs in from an S3 bucket for ALL account activity for the past hour. The function gathers the results, parses them per ROLE, and checks the activity vs the DynamoDB table. If new behavior is detected, and it meets ‘alert’ criteria, an alert event is pushed to Splunk.  The next major difference is the Athena queries. The original code provides the ability to create a table if it does not exist. However, depending on how the data is structured within the S3 buckets, it may need to have paritions manually defined so that Athena can quickly search for the results it needs. Once the partitions have been defined, they must constantly be updated and maintained for each new day. Both of these were challenges that I had to address.\nAnother shift in the Athena queries is around the query to pull activity for the past hour. Initially I leveraged the original query:\nSELECTDISTINCTeventsource,eventnameFROMcloudtrail_123456789WHEREuseridentity.type='AssumedRole'ANDuseridentity.sessioncontext.sessionissuer.principalid='PRINCIPAL_ID'ANDeventTimeto_iso8601(current_timestamp-interval'1'hour);As the capabaility began to scale out I began to run into API rate limits between the Athena queries and S3. I also noticed that despite the fact that the query calls out a specific principal to search for the amount of data scanned by Athena was the same. I decided to shift the principal parsing to the Lambda function and changed the Athena query to pull back all of the account activity for the past hour. This introduced no noticiable overhead to the Lambda function but DRAMATICALLY reduced the number of Athena queries that were requred to produce the same results.\nSELECTDISTINCTeventsource,eventname,useridentity.sessioncontext.sessionissuer.principalid,useridentity.typeFROM\"{business}_ct_anomaly_{account}\"WHEREyear='{year}'ANDmonth='{month}'ANDday='{day}'ANDeventTimeto_iso8601(current_timestamp-interval'1'hour);Another slight change in the query above was to pull back all useridentity types. This allows for some future growth. Instead of just looking at AssumedRole activity, the results now also contain all of the 5 useridentity types. In the future we plan to look at Root account activity, as well as local iam user account activity.\n Issues to Watch For There are a few issues to watch out for. The biggest is to make sure that you are not hitting any rate limits with the Athena queries. AWS is pretty transparent about the rate limits for new query submitions, but the other key limit to look out for is the S3 rate limit. This can cause the queries to die.\nDepening on the Dynamo deployment you may run into some limits when reading and writing. This is another key place to keep an eye out and adjust the deployment as needed.\nThe final place where issues may arise (I’m sure there are others) is with the Lambdas themself. Make sure the run time is long enough to comlete the work. Both Lambdas will run fairly quickly, but you’ll want to make sure you tune them so that they are sized appropriatly.\n Tuning Most of the tuning for incident severity is going to occur within the identity_types.py file. This file is structured with a class for each identity type to analyze. As of writing this the only identity type that is “complete” is the AssumedRole type. The script has the structure built for Root and IAMUser, but they have not been the main focus to get this moved from concept to production.\nThe basic flow of the Assume_Role class is to loop through each role within an AWS account. For each of the roles, loop through all of the cloudtrail events. If the action and the role match, query dynamodb to see if the pairing for the principal, event source, and event action exists within the database. If it does, update the TTL in dynamo. If it does not the script adds it to a list, and then enters into an “alert condition”. The script has several differet stages to determine if it shoudl alert or not as well as what severity to apply to the alert based on various conditions.\nWhat are the conditions to skip the alert? That is widly going to depend on your own environment. Here are some things that you may end up wanting to add, or adjust to fit your deployment.\n Entire roles to ignore Specific actions to ignore If the role is younger than X days (script is currently set to 15) If its an aws service If the number of new actions is less than X (script sets less than 5 to an information severity)  The above list covers what gets ignored, but what about severities? What should the SOC/IR teams spend time on? Once again this is going to entirely depend upon your own environments, the businesses risk tollerances, and other mitigating controls, etc. Within the identity_types.py file there are some sample ratings based on a few different scenarios….\n","wordCount":"1255","inLanguage":"en","datePublished":"2018-11-28T00:00:00Z","dateModified":"2018-11-28T00:00:00Z","author":{"@type":"Person","name":"Travis"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://jellyparks.com/posts/cloudtrail-anomaly-detection/"},"publisher":{"@type":"Organization","name":"JellyParks","logo":{"@type":"ImageObject","url":"https://jellyparks.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://jellyparks.com accesskey=h title="Home (Alt + H)">Home</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://jellyparks.com/posts title=all_posts><span>all_posts</span></a></li><li><a href=https://jellyparks.com/categories/ title=categories><span>categories</span></a></li><li><a href=https://jellyparks.com/tags/ title=tags><span>tags</span></a></li><li><a href=https://jellyparks.com/me/ title=me><span>me</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://jellyparks.com>Home</a>&nbsp;»&nbsp;<a href=https://jellyparks.com/posts/>Posts</a></div><h1 class=post-title>cloudtrail_anomaly_detection</h1><div class=post-meta><span title="2018-11-28 00:00:00 +0000 UTC">November 28, 2018</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Travis&nbsp;|&nbsp;<a href=https://github.com/yogisec/yogisec.github.io/blob/main/content/posts/cloudtrail-anomaly-detection/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#data-flow aria-label="Data Flow">Data Flow</a></li><li><a href=#inspiration aria-label=Inspiration>Inspiration</a></li><li><a href=#structural-differences aria-label="Structural Differences">Structural Differences</a></li><li><a href=#issues-to-watch-for aria-label="Issues to Watch For">Issues to Watch For</a></li><li><a href=#tuning aria-label=Tuning>Tuning</a></li></ul></div></details></div><div class=post-content><hr><p>This is going to be an ongoing post for awhile. It was inspired by Netflix&rsquo;s skunkworks group who gave a <a href="https://www.youtube.com/watch?v=kWJoiZ9yMpg">talk</a> at re:invent 2019 in regards to building a cloudtrail anomaly detection platform leveraging Amazon services. I highly recommend watching the talk.</p><p>I liked the idea, but not the deployment method netflix showcased. It didn&rsquo;t scale to the size I needed it to (Looking at the final product in production now it probably would have, but I didn&rsquo;t want to run and maintain an EC2 instance). Additionally there were also some aspects that I reworked to lessen the load (and cost) of Athena queries. We&rsquo;ll talk more about these differences and more further in the post. This post will walk through <a href=https://github.com/yogisec/cloudtrail-anomaly-serverless>this</a> code.</p><hr><h3 id=data-flow>Data Flow<a hidden class=anchor aria-hidden=true href=#data-flow>#</a></h3><p>Below is how the data and api calls are made within aws. The code in the middle is several Lambda scripts but for the data flow it made sense to consolodate them into a single entity.</p><p>An high level explaination for each of the steps in the diagram is below:</p><ol><li>Query main orgaization account for a list of all accounts within the organization</li><li>Configure Athena tables, start query execution</li><li>Athena queries the CloudTrail S3 bucket(s) for all activity per account for the past hour</li><li>Athena sends results to S3 results bucket</li><li>Athena returns &lsquo;Success&rsquo; message with along with the results object</li><li>Scripts grabs the results and parses them by unique role, event source, and event name</li><li>Each unique record is checked against DynamoDB table. If its new alert (if it meets criteria).</li><li>Send alerts to Splunk</li></ol><p><img loading=lazy src=images/data_flow.png alt=data-flow title=img-fluid></p><hr><h3 id=inspiration>Inspiration<a hidden class=anchor aria-hidden=true href=#inspiration>#</a></h3><p>The original design is a script that runs off an Ec2 instance with the required role to access the CloudTrail events, Athena, S3, and DynamoDB. The original repo is <a href=https://github.com/Netflix-Skunkworks/cloudtrail-anomaly>here</a> and I forked it <a href=https://github.com/yogisec/cloudtrail-anomaly>here</a>.</p><hr><h3 id=structural-differences>Structural Differences<a hidden class=anchor aria-hidden=true href=#structural-differences>#</a></h3><p>While porting the original concept over from what Netflix released. I decided that I didn&rsquo;t want to have to deal with the run and maintain of an EC2 instance. While its not a huge deal, it was just something that I didn&rsquo;t want to do. This is where we have our first major structural difference between the original source, and what was rolled into production. The deployment in my github repo is serverless. Kicked off by cron jobs running every hour.</p><p>Below is a expanded data flow showing the Lambda scripts, and what occurs at each stage.</p><ol><li>Main Lambda function (Muster) kicks off based on CloudWatch cron configuration. It queries for account numbers in the organization, builds a date object, and for each account it sends the account, date object, and miscellaneous variables into an SNS message to trigger the discernment Lambdas.</li><li>SNS message triggers discernment Lambdas. One account per Lambda execution.</li><li>The discernment lambda checks for an Athena table for the account, if it doesn&rsquo;t exist it makes it, it also builds the table partition if it does not exist. Queries the CloudTrail logs in from an S3 bucket for ALL account activity for the past hour. The function gathers the results, parses them per ROLE, and checks the activity vs the DynamoDB table. If new behavior is detected, and it meets &lsquo;alert&rsquo; criteria, an alert event is pushed to Splunk.</li></ol><p><img loading=lazy src=images/lambda_flow.png alt=data-flow title=img-fluid></p><p>The next major difference is the Athena queries. The original code provides the ability to create a table if it does not exist. However, depending on how the data is structured within the S3 buckets, it may need to have paritions manually defined so that Athena can quickly search for the results it needs. Once the partitions have been defined, they must constantly be updated and maintained for each new day. Both of these were challenges that I had to address.</p><p>Another shift in the Athena queries is around the query to pull activity for the past hour. Initially I leveraged the original query:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=k>DISTINCT</span><span class=w> </span><span class=n>eventsource</span><span class=p>,</span><span class=w> </span><span class=n>eventname</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>cloudtrail_123456789</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>useridentity</span><span class=p>.</span><span class=k>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;AssumedRole&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AND</span><span class=w> </span><span class=n>useridentity</span><span class=p>.</span><span class=n>sessioncontext</span><span class=p>.</span><span class=n>sessionissuer</span><span class=p>.</span><span class=n>principalid</span><span class=o>=</span><span class=w> </span><span class=s1>&#39;PRINCIPAL_ID&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AND</span><span class=w> </span><span class=n>eventTime</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>to_iso8601</span><span class=p>(</span><span class=k>current_timestamp</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>interval</span><span class=w> </span><span class=s1>&#39;1&#39;</span><span class=w> </span><span class=n>hour</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>As the capabaility began to scale out I began to run into API rate limits between the Athena queries and S3. I also noticed that despite the fact that the query calls out a specific principal to search for the amount of data scanned by Athena was the same. I decided to shift the principal parsing to the Lambda function and changed the Athena query to pull back all of the account activity for the past hour. This introduced no noticiable overhead to the Lambda function but <strong>DRAMATICALLY</strong> reduced the number of Athena queries that were requred to produce the same results.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=k>DISTINCT</span><span class=w> </span><span class=n>eventsource</span><span class=p>,</span><span class=w> </span><span class=n>eventname</span><span class=p>,</span><span class=w> </span><span class=n>useridentity</span><span class=p>.</span><span class=n>sessioncontext</span><span class=p>.</span><span class=n>sessionissuer</span><span class=p>.</span><span class=n>principalid</span><span class=p>,</span><span class=w> </span><span class=n>useridentity</span><span class=p>.</span><span class=k>type</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=s2>&#34;{business}_ct_anomaly_{account}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=k>year</span><span class=o>=</span><span class=s1>&#39;{year}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AND</span><span class=w> </span><span class=k>month</span><span class=o>=</span><span class=s1>&#39;{month}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AND</span><span class=w> </span><span class=k>day</span><span class=o>=</span><span class=s1>&#39;{day}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AND</span><span class=w> </span><span class=n>eventTime</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>to_iso8601</span><span class=p>(</span><span class=k>current_timestamp</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>interval</span><span class=w> </span><span class=s1>&#39;1&#39;</span><span class=w> </span><span class=n>hour</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>Another slight change in the query above was to pull back all useridentity types. This allows for some future growth. Instead of just looking at AssumedRole activity, the results now also contain all of the 5 useridentity types. In the future we plan to look at Root account activity, as well as local iam user account activity.</p><hr><h3 id=issues-to-watch-for>Issues to Watch For<a hidden class=anchor aria-hidden=true href=#issues-to-watch-for>#</a></h3><p>There are a few issues to watch out for. The biggest is to make sure that you are not hitting any rate limits with the Athena queries. AWS is pretty transparent about the rate limits for new query submitions, but the other key limit to look out for is the S3 rate limit. This can cause the queries to die.</p><p>Depening on the Dynamo deployment you may run into some limits when reading and writing. This is another key place to keep an eye out and adjust the deployment as needed.</p><p>The final place where issues may arise (I&rsquo;m sure there are others) is with the Lambdas themself. Make sure the run time is long enough to comlete the work. Both Lambdas will run fairly quickly, but you&rsquo;ll want to make sure you tune them so that they are sized appropriatly.</p><hr><h3 id=tuning>Tuning<a hidden class=anchor aria-hidden=true href=#tuning>#</a></h3><p>Most of the tuning for incident severity is going to occur within the identity_types.py file. This file is structured with a class for each identity type to analyze. As of writing this the only identity type that is &ldquo;complete&rdquo; is the AssumedRole type. The script has the structure built for Root and IAMUser, but they have not been the main focus to get this moved from concept to production.</p><p>The basic flow of the Assume_Role class is to loop through each role within an AWS account. For each of the roles, loop through all of the cloudtrail events. If the action and the role match, query dynamodb to see if the pairing for the principal, event source, and event action exists within the database. If it does, update the TTL in dynamo. If it does not the script adds it to a list, and then enters into an &ldquo;alert condition&rdquo;. The script has several differet stages to determine if it shoudl alert or not as well as what severity to apply to the alert based on various conditions.</p><p>What are the conditions to skip the alert? That is widly going to depend on your own environment. Here are some things that you may end up wanting to add, or adjust to fit your deployment.</p><ul><li>Entire roles to ignore</li><li>Specific actions to ignore</li><li>If the role is younger than X days (script is currently set to 15)</li><li>If its an aws service</li><li>If the number of new actions is less than X (script sets less than 5 to an information severity)</li></ul><p>The above list covers what gets ignored, but what about severities? What should the SOC/IR teams spend time on? Once again this is going to entirely depend upon your own environments, the businesses risk tollerances, and other mitigating controls, etc. Within the identity_types.py file there are some sample ratings based on a few different scenarios&mldr;.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://jellyparks.com/tags/aws/>aws</a></li><li><a href=https://jellyparks.com/tags/cloud/>cloud</a></li><li><a href=https://jellyparks.com/tags/dfir/>dfir</a></li></ul><nav class=paginav><a class=prev href=https://jellyparks.com/posts/assumed-role-breadcrumbs/><span class=title>« Prev Page</span><br><span>assumed_role_breadcrumbs</span></a>
<a class=next href=https://jellyparks.com/posts/codebuild-secrets/><span class=title>Next Page »</span><br><span>codebuild_secrets</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share cloudtrail_anomaly_detection on twitter" href="https://twitter.com/intent/tweet/?text=cloudtrail_anomaly_detection&url=https%3a%2f%2fjellyparks.com%2fposts%2fcloudtrail-anomaly-detection%2f&hashtags=aws%2ccloud%2cdfir"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share cloudtrail_anomaly_detection on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fjellyparks.com%2fposts%2fcloudtrail-anomaly-detection%2f&title=cloudtrail_anomaly_detection&summary=cloudtrail_anomaly_detection&source=https%3a%2f%2fjellyparks.com%2fposts%2fcloudtrail-anomaly-detection%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share cloudtrail_anomaly_detection on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fjellyparks.com%2fposts%2fcloudtrail-anomaly-detection%2f&title=cloudtrail_anomaly_detection"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share cloudtrail_anomaly_detection on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fjellyparks.com%2fposts%2fcloudtrail-anomaly-detection%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share cloudtrail_anomaly_detection on whatsapp" href="https://api.whatsapp.com/send?text=cloudtrail_anomaly_detection%20-%20https%3a%2f%2fjellyparks.com%2fposts%2fcloudtrail-anomaly-detection%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share cloudtrail_anomaly_detection on telegram" href="https://telegram.me/share/url?text=cloudtrail_anomaly_detection&url=https%3a%2f%2fjellyparks.com%2fposts%2fcloudtrail-anomaly-detection%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://jellyparks.com>JellyParks</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>